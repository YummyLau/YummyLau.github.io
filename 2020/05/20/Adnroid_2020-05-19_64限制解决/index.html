<!DOCTYPE html>




<html class="theme-next gemini" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="æºç ,">










<meta name="description" content="åˆè¡·åˆ†äº«è¿™ä¸ªå¡«å‘çš„è®°å½•ï¼Œä¸»è¦æ˜¯æ„Ÿè§‰èº«è¾¹å¾ˆå¤š Androider éƒ½ä¼šé‡åˆ°å’Œæˆ‘ä¸€æ ·çš„åœºæ™¯ã€‚  é‡åˆ°ä¸€ä¸ª BUG ï¼Œä¼˜å…ˆæŒ‰ç…§è‡ªå·±ç»éªŒä¿®å¤ ä¿®å¤ä¸äº†äº†ï¼Œå¼€å§‹ Googleï¼ˆä¸è¦ç™¾åº¦ï¼Œå†ä¸‰å¼ºè°ƒï¼‰ï¼Œå¯»æ‰¾ä¸€åˆ‡å’Œæˆ‘ä»¬ BUG ç›¸ä¼¼çš„é—®é¢˜ï¼Œç„¶åçœ‹çœ‹æœ‰æ²¡æœ‰è§£å†³æ–¹æ¡ˆ å°è¯•äº†å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼Œa æ–¹æ¡ˆä¸è¡Œæ¢ b æ–¹æ¡ˆï¼Œb æ–¹æ¡ˆä¸è¡Œæ¢ c æ–¹æ¡ˆâ€¦ çŸ¥é“æ²¡æœ‰æ–¹æ¡ˆå¯ä»¥å°è¯•äº†ï¼Œå¼€å§‹ç»æœ›â€¦ å¦‚æœå½±å“ä¸å¤§ï¼Œé‚£å°±ä¸¢åœ¨é¡¹ç›®é‡Œï¼ˆä¼°è®¡ä¹Ÿæ²¡äºº">
<meta name="keywords" content="æºç ">
<meta property="og:type" content="article">
<meta property="og:title" content="æˆ‘æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥çˆ¬ä¸Š â€œ64Ké™åˆ¶â€ çš„å‘ ï½œ ç»éªŒè´´">
<meta property="og:url" content="http://yummylau.com/2020/05/20/Adnroid_2020-05-19_64é™åˆ¶è§£å†³/index.html">
<meta property="og:site_name" content="YummyLau">
<meta property="og:description" content="åˆè¡·åˆ†äº«è¿™ä¸ªå¡«å‘çš„è®°å½•ï¼Œä¸»è¦æ˜¯æ„Ÿè§‰èº«è¾¹å¾ˆå¤š Androider éƒ½ä¼šé‡åˆ°å’Œæˆ‘ä¸€æ ·çš„åœºæ™¯ã€‚  é‡åˆ°ä¸€ä¸ª BUG ï¼Œä¼˜å…ˆæŒ‰ç…§è‡ªå·±ç»éªŒä¿®å¤ ä¿®å¤ä¸äº†äº†ï¼Œå¼€å§‹ Googleï¼ˆä¸è¦ç™¾åº¦ï¼Œå†ä¸‰å¼ºè°ƒï¼‰ï¼Œå¯»æ‰¾ä¸€åˆ‡å’Œæˆ‘ä»¬ BUG ç›¸ä¼¼çš„é—®é¢˜ï¼Œç„¶åçœ‹çœ‹æœ‰æ²¡æœ‰è§£å†³æ–¹æ¡ˆ å°è¯•äº†å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼Œa æ–¹æ¡ˆä¸è¡Œæ¢ b æ–¹æ¡ˆï¼Œb æ–¹æ¡ˆä¸è¡Œæ¢ c æ–¹æ¡ˆâ€¦ çŸ¥é“æ²¡æœ‰æ–¹æ¡ˆå¯ä»¥å°è¯•äº†ï¼Œå¼€å§‹ç»æœ›â€¦ å¦‚æœå½±å“ä¸å¤§ï¼Œé‚£å°±ä¸¢åœ¨é¡¹ç›®é‡Œï¼ˆä¼°è®¡ä¹Ÿæ²¡äºº">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2022-02-06T18:25:08.925Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æˆ‘æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥çˆ¬ä¸Š â€œ64Ké™åˆ¶â€ çš„å‘ ï½œ ç»éªŒè´´">
<meta name="twitter:description" content="åˆè¡·åˆ†äº«è¿™ä¸ªå¡«å‘çš„è®°å½•ï¼Œä¸»è¦æ˜¯æ„Ÿè§‰èº«è¾¹å¾ˆå¤š Androider éƒ½ä¼šé‡åˆ°å’Œæˆ‘ä¸€æ ·çš„åœºæ™¯ã€‚  é‡åˆ°ä¸€ä¸ª BUG ï¼Œä¼˜å…ˆæŒ‰ç…§è‡ªå·±ç»éªŒä¿®å¤ ä¿®å¤ä¸äº†äº†ï¼Œå¼€å§‹ Googleï¼ˆä¸è¦ç™¾åº¦ï¼Œå†ä¸‰å¼ºè°ƒï¼‰ï¼Œå¯»æ‰¾ä¸€åˆ‡å’Œæˆ‘ä»¬ BUG ç›¸ä¼¼çš„é—®é¢˜ï¼Œç„¶åçœ‹çœ‹æœ‰æ²¡æœ‰è§£å†³æ–¹æ¡ˆ å°è¯•äº†å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼Œa æ–¹æ¡ˆä¸è¡Œæ¢ b æ–¹æ¡ˆï¼Œb æ–¹æ¡ˆä¸è¡Œæ¢ c æ–¹æ¡ˆâ€¦ çŸ¥é“æ²¡æœ‰æ–¹æ¡ˆå¯ä»¥å°è¯•äº†ï¼Œå¼€å§‹ç»æœ›â€¦ å¦‚æœå½±å“ä¸å¤§ï¼Œé‚£å°±ä¸¢åœ¨é¡¹ç›®é‡Œï¼ˆä¼°è®¡ä¹Ÿæ²¡äºº">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yummylau.com/2020/05/20/Adnroid_2020-05-19_64é™åˆ¶è§£å†³/">





  <title>æˆ‘æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥çˆ¬ä¸Š â€œ64Ké™åˆ¶â€ çš„å‘ ï½œ ç»éªŒè´´ | YummyLau</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YummyLau</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Keep movingï¼</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yummylau.com/2020/05/20/Adnroid_2020-05-19_64é™åˆ¶è§£å†³/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yummyLau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YummyLau">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">æˆ‘æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥çˆ¬ä¸Š â€œ64Ké™åˆ¶â€ çš„å‘ ï½œ ç»éªŒè´´</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-05-20T00:00:00+08:00">
                2020-05-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/20/Adnroid_2020-05-19_64é™åˆ¶è§£å†³/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/05/20/Adnroid_2020-05-19_64é™åˆ¶è§£å†³/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <a id="more"></a>
<h3 id="åˆè¡·"><a href="#åˆè¡·" class="headerlink" title="åˆè¡·"></a>åˆè¡·</h3><p>åˆ†äº«è¿™ä¸ªå¡«å‘çš„è®°å½•ï¼Œä¸»è¦æ˜¯æ„Ÿè§‰èº«è¾¹å¾ˆå¤š Androider éƒ½ä¼šé‡åˆ°å’Œæˆ‘ä¸€æ ·çš„åœºæ™¯ã€‚</p>
<ol>
<li>é‡åˆ°ä¸€ä¸ª BUG ï¼Œä¼˜å…ˆæŒ‰ç…§è‡ªå·±ç»éªŒä¿®å¤</li>
<li>ä¿®å¤ä¸äº†äº†ï¼Œå¼€å§‹ Googleï¼ˆä¸è¦ç™¾åº¦ï¼Œå†ä¸‰å¼ºè°ƒï¼‰ï¼Œå¯»æ‰¾ä¸€åˆ‡å’Œæˆ‘ä»¬ BUG ç›¸ä¼¼çš„é—®é¢˜ï¼Œç„¶åçœ‹çœ‹æœ‰æ²¡æœ‰è§£å†³æ–¹æ¡ˆ</li>
<li>å°è¯•äº†å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼Œa æ–¹æ¡ˆä¸è¡Œæ¢ b æ–¹æ¡ˆï¼Œb æ–¹æ¡ˆä¸è¡Œæ¢ c æ–¹æ¡ˆâ€¦ çŸ¥é“æ²¡æœ‰æ–¹æ¡ˆå¯ä»¥å°è¯•äº†ï¼Œå¼€å§‹ç»æœ›â€¦</li>
<li>å¦‚æœå½±å“ä¸å¤§ï¼Œé‚£å°±ä¸¢åœ¨é¡¹ç›®é‡Œï¼ˆä¼°è®¡ä¹Ÿæ²¡äººå‘ç°ï¼‰ï¼Œå¦‚æœå½±å“å¾ˆå¤§ï¼Œé‚£åªèƒ½å¯»æ‰¾åˆ«äººå¸®åŠ©ï¼Œå¦‚æœåˆ«äººä¹Ÿç»™ä¸äº†å»ºè®®ï¼Œé‚£å°±åŸåœ°ğŸ’¥ </li>
</ol>
<p>å…¶å®æ— è®ºå½±å“å¤§ä¸å¤§ï¼Œä¸¢åœ¨é¡¹ç›®é‡Œæ€»ä¸å¤ªå¥½ã€‚ å½“åˆ«äººå¸®åŠ©ä¸äº†çš„æ—¶å€™ï¼ŒçœŸçš„å°±åªæœ‰ä»£ç èƒ½å¸®ä½ ã€‚å°è¯•è¿‡å¾ˆå¤šæ–¹æ¡ˆä¸å¯è¡Œï¼Œå¾ˆå¤šæ—¶å€™æ˜¯å› ä¸ºæ¯ä¸ªæ–¹æ¡ˆçš„èƒŒæ™¯ä¸ä¸€æ ·ï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒèƒŒæ™¯å¦‚ gradle ç‰ˆæœ¬ï¼Œç¼–è¯‘ç‰ˆæœ¬ ï¼Œapi ç‰ˆæœ¬ç­‰ã€‚æˆ‘é‡åˆ°çš„è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ </p>
<p>å¸Œæœ›é€šè¿‡ä»¥ä¸‹çš„è®°å½•èƒ½å¸®åŠ©ä½ åœ¨é¢å¯¹æ— èƒ½ä¸ºåŠ›çš„ â€œBUGâ€ æ—¶æ›´åšå®šåœ°å¯»æ‰¾è§£å†³æ–¹æ¡ˆã€‚</p>
<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><blockquote>
<p>åœ¨æˆ‘ä»¬é¡¹ç›®æœ€è¿‘çš„ä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼ŒQA æµ‹è¯• feature åŠŸèƒ½æ—¶åé¦ˆ â€œ4.4è®¾å¤‡ä¸Šï¼ŒAPP éƒ½ crash å•¦ï¼â€ ç”±äºåé¦ˆè¯¥é—®é¢˜çš„æ—¶å€™å·²ç»å¿«å‘¨æœ«äº†ï¼ŒæŒ‰ç…§ PM çš„æµç¨‹æˆ‘ä»¬éœ€è¦åœ¨ä¸‹å‘¨ä¸€å°åŒ…ç»™ MTL åšè´¨é‡æµ‹è¯•ï¼Œè¿™ä¸ªé—®é¢˜å¿…é¡»åœ¨å‘¨ä¸€å‰è§£å†³ã€‚ =ã€‚=</p>
</blockquote>
<p>ç¬¬ä¸€ååº” â€œGGï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯å‘â€ã€‚ç«‹åˆ»å€Ÿäº†ä¸¤å° 4.4 çš„æœºå‹å¯¹å‘ç”Ÿ Crash çš„åŒ…ä½“è¿›è¡Œè°ƒè¯•ï¼Œå‘ç°éƒ½æ˜¯ â€œjava.lang.NoClassDefFoundErrorâ€ã€‚ è¿™ä¸ªcrashè¡¨æ˜æ‰¾ä¸åˆ°å¼•ç”¨çš„ç±»åŸæœ¬åº”è¯¥åœ¨ ä¸» Dex æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯ä¸» Dex æ–‡ä»¶ä¸­å´æ²¡æœ‰æä¾›è¿™ä¸ªç±»ã€‚</p>
<p>éš¾é“æˆ‘ä»¬æ²¡æœ‰ keep ä½è¿™ä¸ªç±»å—ï¼Ÿ ä¸åº”è¯¥å•Šï¼Œæ˜¾ç„¶æ˜¯å› ä¸ºæ„å»ºå·¥å…·å·²ç»çŸ¥é“è¿™ä¸ªç±»åº”è¯¥è¢«æ‰“è¿›å»ï¼Œå´å› ä¸ºæŸäº›åŸå› æ²¡æœ‰è¢«æ‰“è¿›å»ã€‚æˆ‘å°è¯•ä½¿ç”¨ mutilDexKeepProguard keep ä½è¿™ä¸ªç±»ï¼Œç„¶åç¼–è¯‘ç›´æ¥ä¸é€šè¿‡äº†ã€‚æ”¶åˆ°çš„å¼‚å¸¸ä¸ºï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D8: Cannot fit requested classes <span class="keyword">in</span> <span class="keyword">the</span> main-dex <span class="built_in">file</span> (<span class="comment"># methods: 87855 &gt; 65536 ; # fields: 74641 &gt; 65536)</span></span><br></pre></td></tr></table></figure>
<h3 id="å®šä½é—®é¢˜"><a href="#å®šä½é—®é¢˜" class="headerlink" title="å®šä½é—®é¢˜"></a>å®šä½é—®é¢˜</h3><p>ä¸Šè¿°å¼‚å¸¸ä½ å¯èƒ½å¾ˆç†Ÿæ‚‰ã€‚ Dex æ–‡ä»¶è§„èŒƒæ˜ç¡®æŒ‡å‡ºï¼Œå•ä¸ª dex æ–‡ä»¶å†…å¼•ç”¨çš„æ–¹æ³•æ€»æ•°åªèƒ½ä¸º 65536ï¼Œè€Œè¿™ä¸ªé™åˆ¶æ¥æºäºæ˜¯ davilk æŒ‡ä»¤ä¸­è°ƒç”¨æ–¹æ³•çš„å¼•ç”¨ç´¢å¼•æ•°å€¼ï¼Œè¯¥æ•°å€¼é‡‡ç”¨ 16ä½ äºŒè¿›åˆ¶è®°å½•ï¼Œä¹Ÿå°±æ˜¯ 2^16 = 65536ã€‚ è¿™äº›æ–¹æ³•æ•°åŒ…æ‹¬äº† Android Framework å±‚æ–¹æ³•ï¼Œç¬¬ä¸‰æ–¹åº“æ–¹æ³•åŠåº”ç”¨ä»£ç æ–¹æ³•ã€‚</p>
<p>æ‰€è°“ ä¸»dexï¼Œå…¶å®å°±æ˜¯ classes.dexã€‚è¿˜å¯èƒ½å­˜åœ¨ classes1.dex,classes2.dexâ€¦classesN.dexï¼Œå› ä¸ºå®Œæ•´çš„é¡¹ç›®å¯èƒ½åŒ…å«è¶…è¿‡ 65536 ä¸ªæ–¹æ³•ï¼Œå› ä¸ºéœ€è¦å¯¹é¡¹ç›®çš„ class è¿›è¡Œåˆ‡åˆ†ã€‚ä¸»dexä¼šè¢«æœ€å…ˆåŠ è½½ï¼Œå¿…é¡»åŒ…å«å¯åŠ¨å¼•ç”¨æ‰€éœ€è¦çš„ç±»åŠâ€œä¾èµ–ç±»â€ï¼ˆåé¢ä¼šæœ‰è¯¦ç»†ä»‹ç»ï¼‰ã€‚è€Œæˆ‘æ‰€é‡åˆ°çš„é—®é¢˜å°±æ˜¯ â€œåŒ…å«å¯åŠ¨å¼•ç”¨æ‰€éœ€è¦çš„ç±»åŠâ€œä¾èµ–ç±»åŒ…å«çš„æ–¹æ³•æ•°â€ è¶…è¿‡ 65536 ä¸ªï¼Œæ„å»ºç³»ç»Ÿä¸ç»™æˆ‘ç»§ç»­æ„å»ºäº†ã€‚ </p>
<p>äº‹å®ä¸Šï¼Œåœ¨ minsdkVersion &gt;= 21 çš„åº”ç”¨ç¯å¢ƒä¸‹æ˜¯ä¸ä¼šå‡ºç°è¿™ç§å¼‚å¸¸çš„ã€‚å› ä¸ºæ„å»ºapkæ—¶æ–¹æ³•æ•°è™½ç„¶è¶…è¿‡ 65536å¿…é¡»åˆ†åŒ…å¤„ç†å¤§ï¼Œä½†ç”±äºä½¿ç”¨ ART è¿è¡Œçš„è®¾å¤‡åœ¨åŠ è½½ apk æ—¶ä¼šåŠ è½½å¤šä¸ªdexæ–‡ä»¶ï¼Œåœ¨å®‰è£…æ—¶æ‰§è¡Œé¢„ç¼–è¯‘ï¼Œæ‰«æ classesN.dex æ–‡ä»¶ï¼Œå¹¶æŠŠä»–ä»¬ç¼–è¯‘æˆå•ä¸ª.oat æ–‡ä»¶ã€‚æ‰€ä»¥ â€œåŒ…å«å¯åŠ¨å¼•ç”¨æ‰€éœ€è¦çš„ç±»åŠâ€œä¾èµ–ç±»â€  å¯ä»¥æ•£è½åœ¨ä¸åŒçš„ dex æ–‡ä»¶ä¸Šã€‚</p>
<p>ä½†æ˜¯ minsdkVersion &lt; 21 å°±ä¸ä¸€æ ·äº†ï¼Œ5.0ä»¥ä¸‹çš„æœºå‹ç”¨çš„æ˜¯ Dalvik è™šæ‹Ÿæœºï¼Œåœ¨å®‰è£…æ—¶ä»…ä»…ä¼šå¯¹ ä¸»dex åšç¼–è¯‘ä¼˜åŒ–ï¼Œç„¶åå¯åŠ¨çš„æ—¶å€™ç›´æ¥åŠ è½½ ä¸»dexã€‚å¦‚æœå¿…è¦çš„ç±»è¢«æ•£è½åˆ°å…¶ä»–æœªåŠ è½½çš„dexä¸­ï¼Œåˆ™ä¼šå‡ºç°crashã€‚ä¹Ÿå°±æ˜¯å¼€å¤´æ‰€è¯´çš„   <code>java.lang.NoClassDefFoundError</code>ã€‚</p>
<blockquote>
<p>å…³äºè¿™ä¸ªexception å’Œ â€œjava.lang.ClassNoFoundErrorâ€ å¾ˆåƒï¼Œä½†æ˜¯æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚åè€…åœ¨ Androidä¸­å¸¸è§äºæ··æ·†å¼•èµ·ç±»æ— æ³•æ‰¾åˆ°æ‰€è‡´ã€‚</p>
</blockquote>
<h3 id="å¯»æ‰¾è§£å†³æ–¹æ¡ˆ"><a href="#å¯»æ‰¾è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¯»æ‰¾è§£å†³æ–¹æ¡ˆ"></a>å¯»æ‰¾è§£å†³æ–¹æ¡ˆ</h3><p>æ˜ç™½äº†ä¸Šè¿°çš„æŠ€æœ¯èƒŒæ™¯ä¹‹åï¼Œå°±å¯ä»¥æƒ³åŠæ³•å‡å°‘ä¸»dexé‡Œé¢çš„ç±»ï¼ŒåŒæ—¶ç¡®ä¿åº”ç”¨èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ã€‚</p>
<p>ä½†æ˜¯å®˜æ–¹åªå‘Šè¯‰æˆ‘ä»¬ â€œå¦‚ä½• Keep ç±»æ¥æ–°å¢ä¸» dex é‡Œé¢çš„ç±»â€ï¼Œä½†æ˜¯æ²¡æœ‰å‘Šè¯‰æˆ‘ä»¬æ€ä¹ˆå‡å°‘å•Š ï¼å§æ§½äº†â€¦</p>
<p>äºæ˜¯ä¹ï¼Œæˆ‘å¼€å§‹ Google + å„ç§github/issue æŸ¥çœ‹å…³äºå¦‚ä½•é¿å…ä¸» dex æ–¹æ³•çˆ†äº†çš„æ–¹æ¡ˆï¼Œå…¨éƒ½æ˜¯å‡ å¹´å‰çš„æ–‡ç« ï¼Œè¿™äº›æ–‡ç« å‡ºå¥‡ä¸€è‡´åœ°å‘Šè¯‰ä½ ã€‚</p>
<p><strong>â€œå°½é‡é¿å…åœ¨applicationä¸­å¼•ç”¨å¤ªå¤šç¬¬ä¸‰æ–¹å¼€æºåº“æˆ–è€…é¿å…ä¸ºäº†ä¸€äº›ç®€å•çš„åŠŸèƒ½è€Œå¼•å…¥ä¸€ä¸ªè¾ƒå¤§çš„åº“â€</strong></p>
<p><strong>â€œå››å¤§ç»„ä»¶ä¼šè¢«æ‰“åŒ…è¿› classes.dexâ€</strong></p>
<p>é¦–å…ˆæˆ‘è§‰å¾—å¾ˆæ— å¥ˆï¼Œé¦–å…ˆæˆ‘æ— æ³•çŸ¥é“æ„å»ºç³»ç»Ÿæ˜¯å¦‚ä½•å°†æ‰€è°“çš„ â€œå››å¤§ç»„ä»¶â€ æ‰“åŒ…è¿› classes.dexï¼Œæ— ä»è€ƒè¯ã€‚å…¶æ¬¡åœ¨ æœ¬æ¬¡ç‰ˆæœ¬ feature å·²ç»éªŒæ”¶å®Œæ¯•ä¹‹ä¸‹æˆ‘æ— æ³•ç›´æ¥å¯¹å¯åŠ¨çš„ä¾èµ–æ ‘è¿›è¡Œè°ƒæ•´ï¼Œè€Œä¸”ä¸šåŠ¡è¿­ä»£äº†å¾ˆä¹…ï¼Œç§»é™¤æˆ–è€…ç§»åŠ¨ä¸€ä¸ªå¯åŠ¨ä¾èµ–æ˜¯æ¯”è¾ƒå¤§çš„æ”¹åŠ¨ï¼Œé£é™©å¤ªå¤§äº†ã€‚ </p>
<p>æˆ‘éå¸¸åŠªåŠ›åœ°ä¼˜åŒ–ï¼Œå†è·‘ä¸€ä¸‹ã€‚</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D8: Cannot fit requested classes <span class="keyword">in</span> <span class="keyword">the</span> main-dex <span class="built_in">file</span> (<span class="comment"># methods:87463 &gt; 65536 ; # fields: 74531 &gt; 65536)</span></span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶çš„æˆ‘æ˜¯éå¸¸ç»æœ›çš„ï¼ŒæŒ‰ç…§è¿™æ ·ä¼˜åŒ–ä¸å¯èƒ½é™ä½åˆ° 65536 ä»¥ä¸‹ã€‚ </p>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘èŠ±è´¹äº†å¾ˆå¤šæ—¶é—´åœ¨å°è¯•ç½‘ä¸Šæ‰€è¯´çš„å„ç§æ–¹æ¡ˆã€‚ æˆ‘å¾ˆéš¾ç”¨ â€œæµªè´¹â€ æ¥æè¿°å¯¹è¿™æ®µæ—¶é—´çš„ä½¿ç”¨ï¼Œå› ä¸ºå¦‚æœä¸æ˜¯è¿™æ ·ï¼Œæˆ‘å¯èƒ½ä¸ä¼šæ„è¯†åˆ°å¯¹å¾…è¿™ç±»é—®é¢˜ä¸Šæˆ‘çš„åšæ³•å¯èƒ½æ˜¯é”™è¯¯çš„ï¼Œå¹¶æŒ‡å¯¼æˆ‘ä»¥ååº”è¯¥è¿™æ ·åšã€‚</p>
<h3 id="â€œè¢«è¿«â€å•ƒä¸‹æºç "><a href="#â€œè¢«è¿«â€å•ƒä¸‹æºç " class="headerlink" title="â€œè¢«è¿«â€å•ƒä¸‹æºç "></a>â€œè¢«è¿«â€å•ƒä¸‹æºç </h3><p>æ—¢ç„¶æ˜¯ä» .class åˆ°ç”Ÿæˆ .dex ç¯èŠ‚å‡ºç°äº†é—®é¢˜ï¼Œé‚£å°±åªèƒ½ä»æ„å»ºæµç¨‹ä¸­è¯¥ç¯èŠ‚åˆ‡å…¥å»ç†Ÿæ‚‰ã€‚ é¡¹ç›®ç”¨çš„æ˜¯ AGP3.4.1 ç‰ˆæœ¬ï¼Œå¼€å§‹ä» <strong>Transform</strong> æ–¹å‘å»å°è¯•è§£æƒ‘ï¼šä» <a href="https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/" target="_blank" rel="noopener">gradle æºç </a> ä¸­å°è¯•è·Ÿè¸ªå¹¶æ‰¾åˆ°ä¸€ä¸‹é—®é¢˜çš„ç­”æ¡ˆã€‚</p>
<ol>
<li>å¤„ç†åˆ†åŒ…çš„ Transform æ˜¯å“ªä¸ªï¼Œä¸»è¦åšäº†ä»€ä¹ˆ</li>
<li>å½±å“ maindexlist æœ€ç»ˆçš„ keep é€»è¾‘æ˜¯æ€ä¹ˆç¡®å®šçš„ ï¼Ÿ æ„å»ºç³»ç»Ÿæœ¬èº« keep äº†å“ªäº›ï¼Œå¼€å‘è€…å¯ä»¥ keep å“ªäº›ï¼Ÿ</li>
<li>ä»ä¸Šæ¸¸è¾“å…¥ä¸­æ¥å—çš„ clasee æ˜¯æ€ä¹ˆæ ¹æ® kepp é€»è¾‘è¿›è¡Œè¿‡æ»¤çš„</li>
<li>maindexlist æ–‡ä»¶æ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ï¼Œåœ¨å“ªé‡Œç”Ÿæˆã€‚</li>
</ol>
<p>è·Ÿæºç æ¯”è¾ƒç—›è‹¦ï¼Œç‰¹åˆ«æ˜¯ gradle æºç ä¸æ”¯æŒè·³è½¬åªèƒ½ä¸€ä¸ªä¸€ä¸ªç±»æŸ¥ï¼Œæœ‰äº›é€»è¾‘è¦çœ‹ä¸Šå››äº”éã€‚ä¸‹é¢æµç¨‹åªåˆ—å‡ºæ ¸å¿ƒæ­¥éª¤åŠæ–¹æ³•ã€‚</p>
<h4 id="å¯»æ‰¾åˆ†åŒ…-Transform"><a href="#å¯»æ‰¾åˆ†åŒ…-Transform" class="headerlink" title="å¯»æ‰¾åˆ†åŒ… Transform"></a>å¯»æ‰¾åˆ†åŒ… Transform</h4><p>åœ¨åº”ç”¨æ„å»ºæµç¨‹ä¸­ï¼Œä¼šç»å† â€œè¯„ä¼°â€ é˜¶æ®µã€‚å½“ apply â€œcom.android.applicationâ€ æ’ä»¶ä¹‹åï¼Œè¯„ä¼°å‰åä¼šç»å†ä»¥ä¸‹æµç¨‹</p>
<ol>
<li>com.android.build.gradle.BasePlugin#apply()</li>
<li>com.android.build.gradle.BasePlugin#basePluginApply()</li>
<li>com.android.build.gradle.BasePlugin#createTasks()</li>
<li>com.android.build.gradle.BasePlugin#createAndroidTasks()</li>
<li><strong>com.android.build.gradle.internal.VariantManager#createAndroidTasks(</strong>ï¼‰ //é‡ç‚¹å…³æ³¨ä¸€</li>
<li>com.android.build.gradle.internal.VariantManager#createTasksForVariantData()</li>
<li>com.android.build.gradle.internal.ApplicationTaskManager#createTasksForVariantScope()  </li>
<li>com.android.build.gradle.internal.ApplicationTaskManager#addCompileTask() </li>
<li><strong>com.android.build.gradle.internal.TaskManager#createPostCompilationTasks()</strong> //é‡ç‚¹å…³æ³¨äºŒ</li>
<li>com.android.build.gradle.internal.pipeline.TransformManager#addTransform() </li>
</ol>
<p>ä¸Šè¿°æµç¨‹æœ‰ä¸¤ä¸ªç‚¹ç•™æ„ï¼š</p>
<ol>
<li>çŸ¥é“ <code>VariantManager#createAndroidTasks</code> å¼€å§‹æ„å»º Android tasks</li>
<li><code>TaskManager#createPostCompilationTasks()</code> ä¸ºæŸä¸€ä¸ªæ„å»ºåœºæ™¯æ·»åŠ  taskï¼Œå…¶ä¸­åŒ…å«äº†æ”¯æŒ Multi-Dex çš„ task</li>
</ol>
<p>Multi-Dex support æ ¸å¿ƒä»£ç å¦‚ä¸‹</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">D8MainDexListTransform <span class="keyword">multiDexTransform </span>= new D8MainDexListTransform(variantScope)<span class="comment">;</span></span><br><span class="line">transformManager.<span class="keyword">addTransform(taskFactory, </span>variantScope, <span class="keyword">multiDexTransform,</span></span><br><span class="line"><span class="keyword"> </span>       taskName -&gt; &#123;</span><br><span class="line">            File mainDexListFile =</span><br><span class="line">                    variantScope</span><br><span class="line">                            .getArtifacts()</span><br><span class="line">                            .appendArtifact(</span><br><span class="line">                                    InternalArtifactType.LEGACY_MULTIDEX_MAIN_DEX_LIST,</span><br><span class="line">                                    taskName,</span><br><span class="line">                                    <span class="string">"mainDexList.txt"</span>)<span class="comment">;</span></span><br><span class="line">            <span class="keyword">multiDexTransform.setMainDexListOutputFile(mainDexListFile);</span></span><br><span class="line"><span class="keyword"> </span>       &#125;, null, variantScope::<span class="keyword">addColdSwapBuildTask);</span></span><br></pre></td></tr></table></figure>
<p><code>transformManager#addTransform</code>  ä¸€å…±æœ‰6ä¸ªå‚æ•°</p>
<ul>
<li>ç¬¬ä¸‰ä¸ªä¸º multiDexTransform å¯¹è±¡</li>
<li>ç¬¬å››ä¸ªä¸º é¢„é…ç½®çš„ä»»åŠ¡ï¼Œç”¨äºç”Ÿæˆ mainDexList.txt çš„ actionï¼Œå…¶å®å°±æ˜¯ä¸ºäº†å»¶è¿Ÿåˆ›å»ºä»»åŠ¡çš„ï¼Œç”¨äºè®¾ç½® mainDexList.txt æ–‡ä»¶è·¯å¾„ã€‚</li>
</ul>
<p>åˆ°è¿™é‡Œï¼Œæœ‰ç‚¹å¤´ç»ªäº†ã€‚</p>
<h4 id="D8MainDexListTransform-åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#D8MainDexListTransform-åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="D8MainDexListTransform åšäº†ä»€ä¹ˆï¼Ÿ"></a>D8MainDexListTransform åšäº†ä»€ä¹ˆï¼Ÿ</h4><p> <a href="https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/build-system/gradle-core/src/main/java/com/android/build/gradle/internal/transforms/D8MainDexListTransform.kt" target="_blank" rel="noopener">D8MainDexListTransform</a> çš„æ„é€ å™¨å‚æ•°å¾ˆå…³é”®ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D8MainDexListTransform</span></span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> manifestProguardRules: BuildableArtifact,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> userProguardRules: Path? = <span class="literal">null</span>,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> userClasses: Path? = <span class="literal">null</span>,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> includeDynamicFeatures: <span class="built_in">Boolean</span> = <span class="literal">false</span>,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> bootClasspath: Supplier&lt;List&lt;Path&gt;&gt;,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> messageReceiver: MessageReceiver) : Transform(), MainDexListWriter &#123;&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>manifestProguardRules ä¸º aapt æ··æ·†è§„åˆ™ï¼Œç¼–è¯‘æ—¶äº§ç”Ÿåœ¨ <code>build/intermediates/legacy_multidex_appt_derived_proguard_rules</code> ç›®å½•ä¸‹çš„ manifest_keep.txt</li>
<li>userProguardRules ä¸ºé¡¹ç›® multiDexKeepProguard ç”³æ˜çš„ keep è§„åˆ™</li>
<li>userClasses ä¸ºé¡¹ç›® multiDexKeepFile ç”³æ˜çš„ keep class </li>
</ol>
<p>è¿™ä¸‰ä»½æ–‡ä»¶éƒ½ä¼šå½±å“æœ€ç»ˆå†³å®šé‚£äº› class ä¼šè¢«æ‰“åˆ° clesses.dex ä¸­ï¼Œé€»è¾‘åœ¨ <code>transform()</code> é‡Œé¢:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">transform</span><span class="params">(invocation: <span class="type">TransformInvocation</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> inputs = getByInputType(invocation)</span><br><span class="line">        <span class="keyword">val</span> programFiles = inputs[ProguardInput.INPUT_JAR]!!</span><br><span class="line">        <span class="keyword">val</span> libraryFiles = inputs[ProguardInput.LIBRARY_JAR]!! + bootClasspath.<span class="keyword">get</span>()</span><br><span class="line">         <span class="comment">// 1 å¤„</span></span><br><span class="line">        <span class="keyword">val</span> proguardRules =listOfNotNull(manifestProguardRules.singleFile().toPath(), userProguardRules)</span><br><span class="line">        <span class="keyword">val</span> mainDexClasses = mutableSetOf&lt;String&gt;()</span><br><span class="line">        <span class="comment">//  2 å¤„</span></span><br><span class="line">        mainDexClasses.addAll(</span><br><span class="line">            D8MainDexList.generate(</span><br><span class="line">                getPlatformRules(),</span><br><span class="line">                proguardRules,</span><br><span class="line">                programFiles,</span><br><span class="line">                libraryFiles,</span><br><span class="line">                messageReceiver</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// 3 å¤„</span></span><br><span class="line">        <span class="keyword">if</span> (userClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">            mainDexClasses.addAll(Files.readAllLines(userClasses))</span><br><span class="line">        &#125;</span><br><span class="line">        Files.deleteIfExists(outputMainDexList)</span><br><span class="line">        <span class="comment">// 4å¤„</span></span><br><span class="line">        Files.write(outputMainDexList, mainDexClasses)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: D8MainDexList.MainDexListException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> TransformException(<span class="string">"Error while generating the main dex list:<span class="subst">$&#123;System.lineSeparator()&#125;</span><span class="subst">$&#123;e.message&#125;</span>"</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>ç¬¬ä¸€å¤„ä»£ç æ‹¿åˆ° multiDexKeepProguard keep è§„åˆ™.</li>
<li><p>ç¬¬äºŒå¤„ä»£ç ä½¿ç”¨ <code>D8MainDexList#generate</code> ç”Ÿæˆæ‰€æœ‰éœ€è¦ keep åœ¨ classes.dex çš„ class é›†åˆï¼Œ <code>getPlatformRules()</code> æ–¹æ³•ä¸­å¼ºå¼ºåˆ¶å†™æ­»äº†ä¸€äº›è§„åˆ™.</p>
 <figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPlatformRules</span><span class="params">()</span></span>: List&lt;String&gt; = listOf(</span><br><span class="line">    <span class="string">"-keep public class * extends android.app.Instrumentation &#123;\n"</span></span><br><span class="line">            + <span class="string">"  &lt;init&gt;(); \n"</span></span><br><span class="line">            + <span class="string">"  void onCreate(...);\n"</span></span><br><span class="line">            + <span class="string">"  android.app.Application newApplication(...);\n"</span></span><br><span class="line">            + <span class="string">"  void callApplicationOnCreate(android.app.Application);\n"</span></span><br><span class="line">            + <span class="string">"  Z onException(java.lang.Object, java.lang.Throwable);\n"</span></span><br><span class="line">            + <span class="string">"&#125;"</span>,</span><br><span class="line">    <span class="string">"-keep public class * extends android.app.Application &#123; "</span></span><br><span class="line">            + <span class="string">"  &lt;init&gt;();\n"</span></span><br><span class="line">            + <span class="string">"  void attachBaseContext(android.content.Context);\n"</span></span><br><span class="line">            + <span class="string">"&#125;"</span>,</span><br><span class="line">    <span class="string">"-keep public class * extends android.app.backup.BackupAgent &#123; &lt;init&gt;(); &#125;"</span>,</span><br><span class="line">    <span class="string">"-keep public class * implements java.lang.annotation.Annotation &#123; *;&#125;"</span>,</span><br><span class="line">    <span class="string">"-keep public class * extends android.test.InstrumentationTestCase &#123; &lt;init&gt;(); &#125;"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¬¬ä¸‰å¤„ä»£ç æŠŠ multiDexKeepFile ç”³æ˜éœ€è¦ä¿ç•™çš„ class æ·»åŠ åˆ° 2 æ­¥éª¤ç”Ÿæˆçš„é›†åˆä¸­</p>
</li>
<li>ç¬¬å››å‡ºä»£ç æœ€ç»ˆè¾“å…¥åˆ° outputMainDexList ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯åœ¨æ·»åŠ  D8MainDexListTransform çš„æ—¶å€™é¢„è®¾ç½®çš„ mainDexList.txtï¼Œä¿å­˜åœ¨ <code>build/intermediates/legacy_multidex_main_dex_list</code> ç›®å½•ä¸‹ã€‚</li>
</ol>
<p>åˆ°è¿™é‡Œï¼Œæƒ³åŠæ³•åœ¨å‹¾ä½ <code>mainDexList.txt</code>ï¼Œ åœ¨çœŸæ­£æ‰“åŒ… classes.dex ä¹‹å‰ä¿®æ”¹æ–‡ä»¶æ—¶åº”è¯¥èƒ½ä¿è¯æ–¹æ³•æ•°æ§åˆ¶åœ¨ 65536 ä¹‹ä¸‹çš„ã€‚æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº† tinkerï¼Œ tinker ä¹Ÿ keep äº†ä¸€äº›ç±»åˆ° classes.dexã€‚ä» multiDexKeepProguard/multiDexKeepFile æ‰‹æ®µä¸Šä¸å­˜åœ¨æ“ä½œç©ºé—´ï¼Œå› ä¸ºè¿™äº›æ˜¯ä¸šåŠ¡ç¡¬è¦æ±‚çš„é€»è¾‘ã€‚åªèƒ½çœ‹ç¼–è¯‘ä¹‹åç”Ÿæˆçš„ mainDexList.txtï¼Œç„¶åå‡­å€Ÿç»éªŒå»æ‰ä¸€äº›çœ‹èµ·æ¥å¯èƒ½ â€œå‰æœŸä¸éœ€è¦â€ çš„ classï¼Œä½†ç¨å¾®ä¸æ…éƒ½æœ‰å¯èƒ½å¯¼è‡´ crash äº§ç”Ÿã€‚</p>
<h4 id="å¯»æ‰¾æ˜ç¡®çš„-â€œKeepâ€-é“¾"><a href="#å¯»æ‰¾æ˜ç¡®çš„-â€œKeepâ€-é“¾" class="headerlink" title="å¯»æ‰¾æ˜ç¡®çš„ â€œKeepâ€ é“¾"></a>å¯»æ‰¾æ˜ç¡®çš„ â€œKeepâ€ é“¾</h4><p>å¸Œæœ›èƒ½ä»ä»£ç é€»è¾‘ä¸Šå¾—åˆ° â€œæ›´ä¸ºæ˜ç¡®çš„æŒ‡å¯¼â€ï¼Œå°±å¾—äº†è§£ä¸‹ä¸ºå•¥ D8 æ„å»ºæµç¨‹ï¼Œ ä¸ºå•¥ keep äº†é‚£ä¹ˆå¤šç±»ï¼Œè¿™äº›ç±»æ˜¯å¦å­˜åœ¨åˆ å‡çš„ç©ºé—´ã€‚</p>
<p>ä½†æ˜¯æˆ‘åœ¨ gradle æºç ä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°  <strong><a href="https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/build-system/builder/src/main/java/com/android/builder/multidex/D8MainDexList.java" target="_blank" rel="noopener">D8MainDexList.java</a></strong>#generate çš„ç›¸å…³ä¿¡æ¯ï¼Œå®ƒè¢«æ”¾åˆ° <code>build-system</code>  çš„å¦ä¸€ä¸ªç›®å½•ä¸­ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ã€‚</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; generate(</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; mainDexRules,		</span><br><span class="line">        <span class="meta">@NonNull</span> <span class="built_in">List</span>&lt;Path&gt; mainDexRulesFiles,</span><br><span class="line">        <span class="meta">@NonNull</span> Collection&lt;Path&gt; programFiles,</span><br><span class="line">        <span class="meta">@NonNull</span> Collection&lt;Path&gt; libraryFiles,</span><br><span class="line">        <span class="meta">@NonNull</span> MessageReceiver messageReceiver)</span><br><span class="line">        throws MainDexListException &#123;</span><br><span class="line">    D8DiagnosticsHandler d8DiagnosticsHandler =</span><br><span class="line">            <span class="keyword">new</span> InterceptingDiagnosticsHandler(messageReceiver);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        GenerateMainDexListCommand.Builder command =</span><br><span class="line">                GenerateMainDexListCommand.builder(d8DiagnosticsHandler)</span><br><span class="line">                        .addMainDexRules(mainDexRules, Origin.unknown()) <span class="comment">//d8å¼ºåˆ¶å†™æ­»çš„è§„åˆ™</span></span><br><span class="line">                        .addMainDexRulesFiles(mainDexRulesFiles) <span class="comment">//å¼€å‘è€…é€šè¿‡ multiDexKeepProguard æ·»åŠ çš„è§„åˆ™</span></span><br><span class="line">                        .addLibraryFiles(libraryFiles);</span><br><span class="line">        <span class="keyword">for</span> (Path program : programFiles) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Files.isRegularFile(program)) &#123;</span><br><span class="line">                command.addProgramFiles(program);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> (Stream&lt;Path&gt; classFiles = Files.walk(program)) &#123;</span><br><span class="line">                    <span class="built_in">List</span>&lt;Path&gt; allClasses = classFiles</span><br><span class="line">                            .filter(p -&gt; p.toString().endsWith(SdkConstants.DOT_CLASS))</span><br><span class="line">                            .collect(Collectors.toList());</span><br><span class="line">                    command.addProgramFiles(allClasses);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//æœ€ç»ˆè°ƒç”¨ GenerateMainDexList#run</span></span><br><span class="line">        <span class="keyword">return</span> ImmutableList.copyOf(</span><br><span class="line">                GenerateMainDexList.run(command.build(), ForkJoinPool.commonPool()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> getExceptionToRethrow(e, d8DiagnosticsHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æœ€ç»ˆé€šè¿‡æ„å»º <code>GenerateMainDexListCommand</code> å¯¹è±¡å¹¶ä¼ é€’ç»™  <strong>GenerateMainDexList</strong> æ‰§è¡Œã€‚ è¿™ä¸¤ä¸ªç±»åœ¨æˆ‘ä»¬æœ¬åœ° AndroidSdk é‡Œï¼Œè·¯å¾„ä¸º <code>{AndroidSdk}/build-tools/{buildToolsVersion}/lib/d8.jar</code> ä¸­ï¼Œå¯é€šè¿‡ <strong>JD_GUI</strong> å·¥å…·æŸ¥çœ‹ã€‚</p>
<p><em>GenerateMainDexListCommandBuilder#build()</em>  åœ¨æ„å»ºå¯¹è±¡çš„æ—¶å€™åšäº†ä»¥ä¸‹å·¥ä½œï¼š</p>
<ol>
<li>æ„å»º <strong>DexItemFactory</strong> å·¥å‚å¯¹è±¡ï¼Œç”¨äºæ„å»º DexStringï¼ŒDexMethod ç­‰ç›¸å…³ dex ä¿¡æ¯</li>
<li>é¢„å¤„ç†äº†è§„åˆ™æ–‡ä»¶ï¼Œæ¯”å¦‚åˆ é™¤ â€œ#â€ æ³¨è§£ç›¸å…³ç­‰ï¼Œè§£ææˆ <strong>ProguardConfigurationRule</strong> å¯¹è±¡é›†</li>
<li>æ„å»º <strong>AndroidApp</strong> å¯¹è±¡ï¼Œç”¨äºè®°å½•ç¨‹åºèµ„æºçš„ä¿¡æ¯ï¼Œæ¯”å¦‚ dexClassï¼ŒlibraryResource ç­‰ç­‰</li>
</ol>
<p>æœ€ç»ˆä¼ é€’ <strong>AndroidApp</strong>  å¯¹è±¡ ç»™ <em>GenerateMainDexList#run()</em> è°ƒç”¨ã€‚</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;String&gt; run(AndroidApp app, ExecutorService executor) <span class="keyword">throws</span> IOException, ExecutionException &#123;</span><br><span class="line">    <span class="comment">// æ­¥éª¤ä¸€</span></span><br><span class="line">	DirectMappedDexApplication directMappedDexApplication =</span><br><span class="line">		 (<span class="keyword">new</span> ApplicationReader(app, <span class="keyword">this</span>.<span class="keyword">options</span>, 	<span class="keyword">this</span>.timing)).<span class="keyword">read</span>(executor).toDirect();</span><br><span class="line">	<span class="comment">// æ­¥éª¤äºŒ</span></span><br><span class="line">	AppInfoWithSubtyping appInfo = <span class="keyword">new</span> AppInfoWithSubtyping((DexApplication)directMappedDexApplication);</span><br><span class="line">	<span class="comment">// æ­¥éª¤ä¸‰</span></span><br><span class="line">	RootSetBuilder.RootSet mainDexRootSet = </span><br><span class="line">		(<span class="keyword">new</span> RootSetBuilder((DexApplication)directMappedDexApplication, (AppInfo)appInfo, (List)<span class="keyword">this</span>.<span class="keyword">options</span>.mainDexKeepRules, <span class="keyword">this</span>.<span class="keyword">options</span>)).run(executor);</span><br><span class="line">	Enqueuer enqueuer = <span class="keyword">new</span> Enqueuer(appInfo, <span class="keyword">this</span>.<span class="keyword">options</span>, <span class="keyword">true</span>);</span><br><span class="line">	Enqueuer.AppInfoWithLiveness mainDexAppInfo = enqueuer.traceMainDex(mainDexRootSet, <span class="keyword">this</span>.timing);</span><br><span class="line">	<span class="comment">// æ­¥éª¤å››</span></span><br><span class="line">	Set&lt;DexType&gt; mainDexClasses = (<span class="keyword">new</span> MainDexListBuilder(<span class="keyword">new</span> HashSet(mainDexAppInfo.liveTypes), 		(DexApplication)directMappedDexApplication)).run();</span><br><span class="line">	List&lt;String&gt; result = (List&lt;String&gt;)mainDexClasses.stream().map(c -&gt; c.toSourceString().replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + 			<span class="string">".class"</span>).sorted().<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.<span class="keyword">options</span>.mainDexListConsumer != <span class="keyword">null</span>)</span><br><span class="line">  		<span class="keyword">this</span>.<span class="keyword">options</span>.mainDexListConsumer.accept(String.<span class="keyword">join</span>(<span class="string">"\n"</span>, (Iterable)result), (DiagnosticsHandler)<span class="keyword">this</span>.<span class="keyword">options</span>.reporter); </span><br><span class="line">	<span class="keyword">if</span> (mainDexRootSet.reasonAsked.<span class="keyword">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		TreePruner pruner = <span class="keyword">new</span> TreePruner((DexApplication)directMappedDexApplication, mainDexAppInfo.withLiveness(), <span class="keyword">this</span>.<span class="keyword">options</span>);</span><br><span class="line">		DexApplication dexApplication = pruner.run();</span><br><span class="line">		ReasonPrinter reasonPrinter = enqueuer.getReasonPrinter(mainDexRootSet.reasonAsked);</span><br><span class="line">		reasonPrinter.run(dexApplication);</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ­¥éª¤ä¸€ï¼Œæ„å»ºäº† <em>ApplicationReader</em> å¯¹è±¡ï¼Œé˜»å¡ç­‰å¾… <em>read()</em> æ–¹æ³•è¯»å–äº†æ‰€æœ‰ç¨‹åºçš„èµ„æºï¼Œå¦‚æœæ˜¯å­˜åœ¨ .dex èµ„æºï¼Œåˆ™å½’ç±»åˆ° dex ç±»å‹ï¼›å¦‚æœå­˜åœ¨ class ç±»å‹ï¼Œåˆ™å½’åˆ° class ç±»å‹ï¼ˆä½†æ˜¯è¿‡æ»¤äº† module-info.class çš„æ–‡ä»¶ï¼‰ã€‚è¿™éƒ¨åˆ†é€»è¾‘å¯åœ¨ <code>com.android.tools.r8.util.FilteredArchiveProgramResourceProvider</code> æŸ¥çœ‹ã€‚dex ç±»å‹ä½¿ç”¨ dex æ ¼å¼è§£æï¼Œclass ç±»å‹ä½¿ç”¨å­—èŠ‚ç æ ¼å¼è§£æä¹‹åä¿å­˜åˆ° <em>directMappedDexApplication</em>  å¯¹è±¡ä¸­ã€‚</li>
<li>æ­¥éª¤äºŒ <strong>AppInfoWithSubtyping</strong> è¯»å–äº† <em>directMappedDexApplication</em>ï¼Œè®¡ç®—å¹¶è®¾ç½®ç±»çš„super/sub å…³ç³»ã€‚</li>
<li>æ­¥éª¤ä¸‰ æŠŠæ‰€æœ‰æ”¶é›†åˆ°çš„ç±»ä¿¡æ¯åŠç±»çš„super/sub å…³ç³»ï¼ŒåŠ keep çš„è§„åˆ™ä¼ é€’ç»™ RootSetBuilder ç”¨äºè®¡ç®— <strong>Root</strong> é›†åˆï¼Œè¯¥é›†åˆå†³å®šå“ªäº›ç±»å°†æœ€ç»ˆè¢« keep åˆ° classes.dex é‡Œé¢ã€‚ç»è¿‡åŒ¹é…æ··æ·†ä¹‹åè·å¾— <strong>Root</strong> é›†åˆä¹‹åï¼Œè°ƒç”¨ <em>run()</em> è¿›è¡Œå‘ä¸‹æ£€ç´¢ã€‚ä¸»è¦æ˜¯è®¡ç®— <strong>Root</strong>  é›†åˆå†…çš„ class çš„ä¾èµ–åŠä½¿ç”¨æšä¸¾ä½œä¸ºè¿è¡Œæ—¶æ³¨è§£ç±»ã€‚</li>
<li>æ­¥éª¤å›› æ ¹æ® <strong>Root</strong> é›†åˆï¼ŒæŒ‰ç…§ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•é¡ºåºæ£€ç´¢å¾—åˆ° <strong>mainDexClass</strong> é›†åˆï¼Œæ–¹æ³•é€»è¾‘å¦‚ä¸‹ã€‚<ol>
<li><code>traceMainDexDirectDependencies()</code>æ–¹æ³• <ul>
<li>æ·»åŠ  Root èŠ‚ç‚¹ classï¼Œæ·»åŠ å…¶æ‰€æœ‰çˆ¶ç±»åŠæ¥å£ï¼›</li>
<li>æ·»åŠ  Root èŠ‚ç‚¹ class ä¸­é™æ€å˜é‡ï¼Œæˆå‘˜å˜é‡ï¼›</li>
<li>æ·»åŠ  Root èŠ‚ç‚¹ class ä¸­çš„æ–¹æ³•çš„å‚æ•°ç±»å‹çš„ classï¼Œè¿”å›å€¼ç±»å‹å¯¹åº”çš„ classï¼›</li>
<li>æ”¶é›† Root èŠ‚ç‚¹ class çš„æ³¨è§£ã€‚</li>
</ul>
</li>
<li><code>traceRuntimeAnnotationsWithEnumForMainDex()</code> æ–¹æ³•<ul>
<li>æ‰€æœ‰ç±»ä¸­ï¼Œå¦‚æœ class æ˜¯æ³¨è§£ç±»å‹ä¸”ä½¿ç”¨æšä¸¾ç±»ï¼Œåˆ™æ”¶é›†ï¼›</li>
<li>æ‰€æœ‰ç±»ä¸­ï¼Œå¦‚æœ class ä½¿ç”¨äº†ä¸Šä¸€æ¡è§„åˆ™çš„æšä¸¾ç±»ä¸”æšä¸¾å¯è§ï¼Œåˆ™ä¹Ÿæ”¶é›†ã€‚</li>
</ul>
</li>
</ol>
</li>
</ul>
<p>å› æ­¤ï¼Œæœ€ç»ˆç”Ÿæˆçš„é›†åˆï¼Œä¼šåœ¨ <strong><a href="https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/build-system/gradle-core/src/main/java/com/android/build/gradle/internal/transforms/D8MainDexListTransform.kt" target="_blank" rel="noopener">D8MainDexListTransform</a></strong>#transform ä¸­åˆå¹¶å­˜åœ¨çš„ multiDexKeepFile è§„åˆ™ï¼Œå¹¶æœ€ç»ˆå†™åˆ° <code>build/intermediates/legacy_mltidex_main_dex_list/</code> ç›®å½•ä¸‹çš„ <code>maindexlist.txt</code> æ–‡ä»¶ã€‚</p>
<h3 id="å°è¯•æ–°æ–¹æ¡ˆ"><a href="#å°è¯•æ–°æ–¹æ¡ˆ" class="headerlink" title="å°è¯•æ–°æ–¹æ¡ˆ"></a>å°è¯•æ–°æ–¹æ¡ˆ</h3><p>é‚£ä¹ˆ <strong>D8MainDexListTransform</strong> èƒ½å¤Ÿè¢«æˆ‘å‹¾ä½ä½¿ç”¨å‘¢ï¼Ÿ å½“ç„¶å¯ä»¥ã€‚ æ‰¾åˆ° <strong>D8MainDexListTransform</strong> å¯¹åº”çš„ <strong>Task</strong>ï¼Œå¯ä»¥é€šè¿‡ <em>project.tasks.findByName</em> æ¥è·å– <em>task</em> å¯¹è±¡ï¼Œç„¶ååœ¨ gradle è„šæœ¬ä¸­ç›‘å¬è¿™ä¸ª <em>task</em> çš„æ‰§è¡Œï¼Œåœ¨ task ç»“æŸä¹‹åå¹¶è¿”å›ç»“æœä¹‹å‰æ’å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ taskï¼Œå¯é€šè¿‡ <em>finalizeBy</em> æ–¹æ³•å®ç°ã€‚</p>
<p>è€Œ D8MainDexListTransform å¯¹åº” Task çš„åå­—çš„é€»è¾‘é€šè¿‡é˜…è¯» <a href="https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/build-system/gradle-core/src/main/java/com/android/build/gradle/internal/pipeline/TransformManager.java" target="_blank" rel="noopener">TransformManager</a>#getTaskNamePrefix å¯æ¨æ–­ã€‚</p>
<p>æŠŠä¸Šè¿°æ‰€æœ‰é€»è¾‘å°è£…æˆä¸€ä¸ª gradle è„šæœ¬å¹¶åœ¨ application æ¨¡å—ä¸­ apply å°±è¡Œäº†ã€‚</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">project</span>.afterEvaluate &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">println</span> <span class="string">"handle main-dex by userï¼Œstart..."</span></span><br><span class="line">    <span class="keyword">if</span> (android.defaultConfig.minSdkVersion.getApiLevel() &gt;= <span class="number">21</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">println</span> <span class="string">"main-dexï¼ŒminSdkVersion is $&#123;android.defaultConfig.minSdkVersion.getApiLevel()&#125;"</span></span><br><span class="line">    android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> variantName = variant.name.capitalize()</span><br><span class="line">        <span class="keyword">def</span> multidexTask = <span class="keyword">project</span>.tasks.findByName(<span class="string">"transformClassesWithMultidexlistFor$&#123;variantName&#125;"</span>)</span><br><span class="line">        <span class="keyword">def</span> exist = multidexTask != <span class="keyword">null</span></span><br><span class="line">        <span class="keyword">println</span> <span class="string">"main-dex multidexTask(transformClassesWithMultidexlistFor$&#123;variantName&#125;) exist: $&#123;exist&#125;"</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (exist) &#123;</span><br><span class="line">            <span class="keyword">def</span> replaceTask = createReplaceMainDexListTask(variant);</span><br><span class="line">            multidexTask.finalizedBy replaceTask</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> createReplaceMainDexListTask(variant) &#123;</span><br><span class="line">    <span class="keyword">def</span> variantName = variant.name.capitalize()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">task</span>(<span class="string">"replace$&#123;variantName&#125;MainDexClassList"</span>).<span class="keyword">doLast</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä»ä¸»dexç§»é™¤çš„åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">def</span> excludeClassList = []</span><br><span class="line">        <span class="keyword">File</span> excludeClassFile = <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">"&#123;å­˜æ”¾å‰”é™¤è§„åˆ™çš„è·¯å¾„&#125;/main_dex_exclude_class.txt"</span>)</span><br><span class="line">        <span class="keyword">println</span> <span class="string">"$&#123;project.projectDir&#125;/main_dex_exclude_class.txt exist: $&#123;excludeClassFile.exists()&#125;"</span></span><br><span class="line">        <span class="keyword">if</span> (excludeClassFile.exists()) &#123;</span><br><span class="line">            excludeClassFile.<span class="keyword">eachLine</span> &#123; line -&gt;</span><br><span class="line">                <span class="keyword">if</span> (!line.trim().isEmpty() &amp;&amp; !line.startsWith(<span class="string">"#"</span>)) &#123;</span><br><span class="line">                    excludeClassList.add(line.trim())</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            excludeClassList.unique()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">def</span> mainDexList = []</span><br><span class="line">        <span class="keyword">File</span> mainDexFile = <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">"$&#123;project.buildDir&#125;/intermediates/legacy_multidex_main_dex_list/$&#123;variant.dirName&#125;/transformClassesWithMultidexlistFor$&#123;variantName&#125;/maindexlist.txt"</span>)</span><br><span class="line">        <span class="keyword">println</span> <span class="string">"$&#123;project.buildDir&#125;/intermediates/legacy_multidex_main_dex_list/$&#123;variant.dirName&#125;/transformClassesWithMultidexlistFor$&#123;variantName&#125;/maindexlist.txt exist : $&#123;mainDexFile.exists()&#125;"</span></span><br><span class="line">        <span class="comment">//å†æ¬¡åˆ¤æ–­å…¼å®¹ linux/mac ç¯å¢ƒè·å–</span></span><br><span class="line">        <span class="keyword">if</span>(!mainDexFile.exists())&#123;</span><br><span class="line">            mainDexFile = <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">"$&#123;project.buildDir&#125;/intermediates/legacy_multidex_main_dex_list/$&#123;variant.dirName&#125;/transformClassesWithMultidexlistFor$&#123;variantName&#125;/mainDexList.txt"</span>)</span><br><span class="line">            <span class="keyword">println</span> <span class="string">"$&#123;project.buildDir&#125;/intermediates/legacy_multidex_main_dex_list/$&#123;variant.dirName&#125;/transformClassesWithMultidexlistFor$&#123;variantName&#125;/mainDexList.txt exist : $&#123;mainDexFile.exists()&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mainDexFile.exists()) &#123;</span><br><span class="line">            mainDexFile.<span class="keyword">eachLine</span> &#123; line -&gt;</span><br><span class="line">                <span class="keyword">if</span> (!line.isEmpty()) &#123;</span><br><span class="line">                    mainDexList.add(line.trim())</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mainDexList.unique()</span><br><span class="line">            <span class="keyword">if</span> (!excludeClassList.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">def</span> newMainDexList = mainDexList.findResults &#123; mainDexItem -&gt;</span><br><span class="line">                    <span class="keyword">def</span> isKeepMainDexItem = <span class="keyword">true</span></span><br><span class="line">                    <span class="keyword">for</span> (excludeClassItem in excludeClassList) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mainDexItem.contains(excludeClassItem)) &#123;</span><br><span class="line">                            isKeepMainDexItem = <span class="keyword">false</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isKeepMainDexItem) mainDexItem <span class="keyword">else</span> <span class="keyword">null</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (newMainDexList.<span class="keyword">size</span>() &lt; mainDexList.<span class="keyword">size</span>()) &#123;</span><br><span class="line">                    mainDexFile.<span class="keyword">delete</span>()</span><br><span class="line">                    mainDexFile.createNewFile()</span><br><span class="line">                    mainDexFile.<span class="keyword">withWriterAppend</span> &#123; writer -&gt;</span><br><span class="line">                        newMainDexList.<span class="keyword">each</span> &#123;</span><br><span class="line">                            writer &lt;&lt; it &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">                            writer.flush()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œ <code>main_dex_exclude_class.txt</code>  çš„å†…å®¹å¾ˆç®€å•ï¼Œè§„åˆ™å’Œ multiDexKeepFile æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com<span class="regexp">/facebook/</span>fresco</span><br><span class="line">com<span class="regexp">/android/</span>activity/BaseLifeActivity.<span class="keyword">class</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥å•¦ï½ å¦‚æœä½ æ‰¾ä¸åˆ° D8MainDexListTransform å¯¹åº”çš„ Taskï¼Œé‚£ä½ åº”è¯¥æ˜¯ç”¨äº† r8 ï¼Œr8 ä¼šåˆå¹¶ mainDexList çš„æ„å»ºæµç¨‹åˆ°æ–°çš„ Taskï¼Œä½ å¯ä»¥é€‰æ‹©å…³é—­ r8 æˆ–è€…å¯»æ‰¾æ–°çš„ hook ç‚¹ï¼Œæ€è·¯æ˜¯ä¸€æ ·çš„ã€‚</p>
<p><strong>â€œä»€ä¹ˆï¼Œä½ è®²äº†ä¸€éæµç¨‹ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰è¯´å“ªäº›å¯ä»¥åˆ   â€</strong></p>
<p><strong>â€œå…¶å®ï¼Œé™¤äº† D8 å¼ºåˆ¶ keep ä½çš„ç±»å’Œ contentProvider, å…¶ä»–éƒ½å¯ä»¥åˆ ã€‚â€</strong></p>
<p><strong>â€œä½†æ˜¯æˆ‘çœ‹åˆ°ç½‘ä¸Šå¾ˆå¤šæ–‡ç« è¯´ï¼Œå››å¤§ç»„ä»¶éƒ½è¦ keep ä½å“¦â€</strong></p>
<p><strong>â€œå»ºè®®ä»¥æˆ‘ä¸ºå‡†ã€‚â€</strong></p>
<p>å½“ç„¶ï¼Œæˆ‘å·²ç»è¯•è¿‡äº†ï¼Œä½ æŠŠå…¥å£ Activity åˆ é™¤ï¼Œä¹Ÿåªæ˜¯æ…¢ä¸€äº›è€Œå·²ï¼Œåªæ˜¯ä¸å»ºè®®ç½¢äº†ã€‚æˆ–è€…ä½ å¯ä»¥é€‰æ‹©æŠŠäºŒçº§é¡µé¢å…¨éƒ¨ç§»é™¤å‡ºå»ï¼Œè¿™æ ·å¯èƒ½ä¼šå¤§å¤§å‡å°‘  classes.dex çš„æ–¹æ³•æ•°ã€‚</p>
<p><strong>æœ€ç»ˆæ•ˆæœï¼š methods: 87855 &gt; 49386ã€‚</strong></p>
<p>ä¸Šè¿°åˆ†æå­˜åœ¨é”™è¯¯æ¬¢è¿æŒ‡æ­£æˆ–æœ‰æ›´å¥½çš„å¤„ç†å»ºè®®ï¼Œæ¬¢è¿è¯„è®ºç•™è¨€å“¦ã€‚ </p>
<blockquote>
<p>è§£å†³é—®é¢˜å¾ˆç—›è‹¦ï¼Œé€¼ç€ä½ å»å¯»æ‰¾ç­”æ¡ˆï¼Œä½†è§£å†³ä¹‹åçœŸçš„çˆ½ã€‚</p>
</blockquote>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
    yummyLau
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="http://yummylau.com/2020/05/20/Adnroid_2020-05-19_64é™åˆ¶è§£å†³/" title="æˆ‘æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥çˆ¬ä¸Š â€œ64Ké™åˆ¶â€ çš„å‘ ï½œ ç»éªŒè´´">http://yummylau.com/2020/05/20/Adnroid_2020-05-19_64é™åˆ¶è§£å†³/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/æºç /" rel="tag"># æºç </a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/13/é¢è¯•_2020-05-13_è¿™äº›å¹´ï¼Œæˆ‘æ‰€ç»å†çš„é¢è¯•ï½œå†™åœ¨æ­£åœ¨æ±‚èŒçš„ Androider/" rel="next" title="è¿™äº›å¹´ï¼Œæˆ‘æ‰€ç»å†çš„æ‰€æœ‰é¢è¯•ï½œå†™ç»™æ­£åœ¨æ±‚èŒçš„ Androider">
                <i class="fa fa-chevron-left"></i> è¿™äº›å¹´ï¼Œæˆ‘æ‰€ç»å†çš„æ‰€æœ‰é¢è¯•ï½œå†™ç»™æ­£åœ¨æ±‚èŒçš„ Androider
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/27/ä¸€ä¸ªæ›´è´´è¿‘ android åœºæ™¯çš„å¯åŠ¨æ¡†æ¶ | Anchors/" rel="prev" title="ä¸€ä¸ªæ›´è´´è¿‘ android åœºæ™¯çš„å¯åŠ¨æ¡†æ¶ | Anchors">
                ä¸€ä¸ªæ›´è´´è¿‘ android åœºæ™¯çš„å¯åŠ¨æ¡†æ¶ | Anchors <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpg" alt="yummyLau">
            
              <p class="site-author-name" itemprop="name">yummyLau</p>
              <p class="site-description motion-element" itemprop="description">åŠªåŠ›è®©è‡ªå·±æ›´ä¼˜ç§€ã€‚</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">87</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/YummyLau" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆè¡·"><span class="nav-number">1.</span> <span class="nav-text">åˆè¡·</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#èƒŒæ™¯"><span class="nav-number">2.</span> <span class="nav-text">èƒŒæ™¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®šä½é—®é¢˜"><span class="nav-number">3.</span> <span class="nav-text">å®šä½é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯»æ‰¾è§£å†³æ–¹æ¡ˆ"><span class="nav-number">4.</span> <span class="nav-text">å¯»æ‰¾è§£å†³æ–¹æ¡ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#â€œè¢«è¿«â€å•ƒä¸‹æºç "><span class="nav-number">5.</span> <span class="nav-text">â€œè¢«è¿«â€å•ƒä¸‹æºç </span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#å¯»æ‰¾åˆ†åŒ…-Transform"><span class="nav-number">5.1.</span> <span class="nav-text">å¯»æ‰¾åˆ†åŒ… Transform</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#D8MainDexListTransform-åšäº†ä»€ä¹ˆï¼Ÿ"><span class="nav-number">5.2.</span> <span class="nav-text">D8MainDexListTransform åšäº†ä»€ä¹ˆï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å¯»æ‰¾æ˜ç¡®çš„-â€œKeepâ€-é“¾"><span class="nav-number">5.3.</span> <span class="nav-text">å¯»æ‰¾æ˜ç¡®çš„ â€œKeepâ€ é“¾</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å°è¯•æ–°æ–¹æ¡ˆ"><span class="nav-number">6.</span> <span class="nav-text">å°è¯•æ–°æ–¹æ¡ˆ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yummyLau</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'pPdkM9YTrgYDV8coDCdALdmi-gzGzoHsz',
        appKey: '5HrONz3gb8XPDrUna01sa0gY',
        placeholder: 'ç•™ä¸‹ä½ çš„è¶³è¿¹å‘— ãƒ¾ï¾‰â‰§âˆ€â‰¦)o',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
