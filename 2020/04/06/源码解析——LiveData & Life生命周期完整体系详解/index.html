<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android进阶,源码分析,">










<meta name="description" content="LiveData 作为 Jetpack 的一部分，扛着 “告知界面视图发生数据变化” 的责任，常与 Lifecycles 联合使用用于数据层驱动视图层作出变化的手段。随着项目迭代，我们的项目 MVP 架构中 rxjava 驱动更新视图演化成 MVVM 架构中 rxjava + LiveData + Lifecycles 组合，rxjava 仅仅作为数据源产生-处理的手段，最后输出到 LiveD">
<meta name="keywords" content="Android进阶,源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="源码解析——LiveData &amp; Lifecycles 完整体系详解">
<meta property="og:url" content="http://yummylau.com/2020/04/06/源码解析——LiveData & Life生命周期完整体系详解/index.html">
<meta property="og:site_name" content="YummyLau">
<meta property="og:description" content="LiveData 作为 Jetpack 的一部分，扛着 “告知界面视图发生数据变化” 的责任，常与 Lifecycles 联合使用用于数据层驱动视图层作出变化的手段。随着项目迭代，我们的项目 MVP 架构中 rxjava 驱动更新视图演化成 MVVM 架构中 rxjava + LiveData + Lifecycles 组合，rxjava 仅仅作为数据源产生-处理的手段，最后输出到 LiveD">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/YummyLau/hexo/master/source/pics/20200406/livedata_1.png">
<meta property="og:updated_time" content="2020-04-06T04:55:50.092Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="源码解析——LiveData &amp; Lifecycles 完整体系详解">
<meta name="twitter:description" content="LiveData 作为 Jetpack 的一部分，扛着 “告知界面视图发生数据变化” 的责任，常与 Lifecycles 联合使用用于数据层驱动视图层作出变化的手段。随着项目迭代，我们的项目 MVP 架构中 rxjava 驱动更新视图演化成 MVVM 架构中 rxjava + LiveData + Lifecycles 组合，rxjava 仅仅作为数据源产生-处理的手段，最后输出到 LiveD">
<meta name="twitter:image" content="https://raw.githubusercontent.com/YummyLau/hexo/master/source/pics/20200406/livedata_1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yummylau.com/2020/04/06/源码解析——LiveData & Life生命周期完整体系详解/">





  <title>源码解析——LiveData & Lifecycles 完整体系详解 | YummyLau</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YummyLau</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Keep moving！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yummylau.com/2020/04/06/源码解析——LiveData & Life生命周期完整体系详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yummyLau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YummyLau">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">源码解析——LiveData & Lifecycles 完整体系详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-06T00:00:00+08:00">
                2020-04-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android进阶/" itemprop="url" rel="index">
                    <span itemprop="name">Android进阶</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/06/源码解析——LiveData & Life生命周期完整体系详解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/04/06/源码解析——LiveData & Life生命周期完整体系详解/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <a id="more"></a>
<blockquote>
<p>LiveData 作为 Jetpack 的一部分，扛着 “告知界面视图发生数据变化” 的责任，常与 Lifecycles 联合使用用于数据层驱动视图层作出变化的手段。随着项目迭代，我们的项目 MVP 架构中 rxjava 驱动更新视图演化成 MVVM 架构中 rxjava + LiveData + Lifecycles 组合，rxjava 仅仅作为数据源产生-处理的手段，最后输出到 LiveData 由其根据 Lifecycles 的生命感知作出对 UI 调整。 当然，rxjava + LiveData + Lifecycles + binding 则可以进一步进行数据视图双绑定，也一直在尝试中。</p>
</blockquote>
<p>LiveData + Lifecycles 未来依然作为数据层通知视图更改的手段，对于项目架构的重要角色，深入理解并熟悉运用是必要的，尤其是在 codeReview 上可以基于更多项目代码的改进，提升代码质量。</p>
<p>针对 LiveData + Lifecycles 体系，本文会围绕以下几点展开，顺着我的逻辑对整个体系进行掌握，相信你可以对整个体系由更完整的理解。</p>
<blockquote>
<p>我希望你已经实践过 LiveData 并希望进一步了解更多细节。 </p>
</blockquote>
<p>在此，先看一张整个体系的类图结构，下面任何篇章的内容都可以回归到这张结构图。整个体系可以分割为五大部分，前四部分是核心的逻辑，形成整个体系的闭环，最后一部分是扩展思考，留给读者自行思考。</p>
<p><img src="https://raw.githubusercontent.com/YummyLau/hexo/master/source/pics/20200406/livedata_1.png" align="center"></p>
<ul>
<li>LiveData 如何接收并分发数据 ？</li>
<li>Observer 如何关联具有生命周期特征的角色，怎么接收数据 ？</li>
<li>谁是拥有 “生命周期特征” 的角色？</li>
<li>Activity/Fragment 是如何成为 LifecycleOwner？</li>
<li>扩展思考</li>
</ul>
<h3 id="LiveData-如何接收并分发数据"><a href="#LiveData-如何接收并分发数据" class="headerlink" title="LiveData 如何接收并分发数据"></a>LiveData 如何接收并分发数据</h3><p>LiveData 既一个数据接收者，也是一个数据分发者。</p>
<p>数据接收的方法有两个 <code>setValue</code> 和 <code>postValue</code>。唯一差别在于，<code>posttValue</code> 会通过 <code>handler</code> 手段在主线程调用 <code>setValue</code>，并通过 <strong>对象锁</strong> 保证数据接收的同步性。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">"setValue"</span>);</span><br><span class="line">    mVersion++;</span><br><span class="line">    mData = value;</span><br><span class="line">    dispatchingValue(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> postTask;</span><br><span class="line">    <span class="keyword">synchronized</span> (mDataLock) &#123;	<span class="comment">//post之前先上锁</span></span><br><span class="line">        postTask = mPendingData == NOT_SET;</span><br><span class="line">        mPendingData = value;   <span class="comment">//保存临时数据</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!postTask) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable mPostValueRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object newValue;</span><br><span class="line">        <span class="keyword">synchronized</span> (mDataLock) &#123;	<span class="comment">//主线程同步获取到临时保存的数据</span></span><br><span class="line">            newValue = mPendingData;</span><br><span class="line">            mPendingData = NOT_SET;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        setValue((T) newValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 <code>setValue</code> 保存了当前接收的 <em>value</em> 对象之后，<em>mVersion</em> 递增加一，接着进行数据分发。<em>mVersion</em> 实际上表示的是 <strong>LiveData</strong> 当前接收到的数据的 “新鲜程度”。<em>mVersion</em> 值越大数据就越新，这个 “新鲜程度” 对比的时后面 <strong>Observer</strong> 已经接收的数据。</p>
<p>在看分发逻辑之前，有两个比较关键的变量需要先理解好</p>
<ul>
<li><em>mDispatchingValue</em> 表示当前 <strong>LiveData</strong> 是否正在分发数据</li>
<li><em>mDispatchInvalidated</em> 表示当前 <strong>LiveData</strong> 当前分发是否无效，如果当前分发无效则需要重新分发/</li>
</ul>
<p>为什么 LiveData 当前分发会无效？ 实际上是因为，<strong>LiveData</strong> 分发是一个针对特定 <em>observer</em> 或遍历所有 <strong>Observer</strong> 并逐个分发的过程。当分发到中间时，突然有新的 <em>observer</em> 需要分发或者 <strong>LiveData</strong>  接收到新的数值需要分发数据，此时第一次的分发还没有完成则被认为是无效的分发，需重新遍历分发。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void dispatchingValue(<span class="meta">@Nullable</span> ObserverWrapper initiator) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;		<span class="comment">//如果正在分发，则认为已经遍历分发的过程是无效的</span></span><br><span class="line">        mDispatchInvalidated = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDispatchingValue = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="literal">null</span>) &#123;</span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123; <span class="comment">//break 之后重新循环遍历        </span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    mDispatchingValue = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> void considerNotify(ObserverWrapper observer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;	<span class="comment">//如果当前状态发生变化，则</span></span><br><span class="line">        observer.activeStateChanged(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    observer.mLastVersion = mVersion;</span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面讲述的逻辑你可能有疑惑 <em>observer</em> 不是一个单纯的观察者吗？ 但是上面的逻辑却涉及是否激活 （mActive） 等信息。实际上，<strong>Observer</strong> 确实是一个单纯的观察者，只是 <strong>LiveData</strong> 在分发数据的时候当它与某个拥有生命周期特征的角色相关联了。</p>
<p>下面就是介绍 “Observer 作为一个数据接收的角色，是怎么关联某个拥有生命周期的角色，进而怎么影响它接收数据的”</p>
<h3 id="Observer-如何关联具有生命周期特征的角色，怎么接收数据"><a href="#Observer-如何关联具有生命周期特征的角色，怎么接收数据" class="headerlink" title="Observer 如何关联具有生命周期特征的角色，怎么接收数据"></a>Observer 如何关联具有生命周期特征的角色，怎么接收数据</h3><p>上一章节，<strong>LiveData</strong> 分发的对象实际上的 <strong>ObserverWrapper</strong> 对象. 从类的字面意识就是 观察者的包装类。<br>先举个例子</p>
<blockquote>
<p>假如安保人员（观察者）在线下看到一个人（被观察者）在偷东西，则基于此行为（事件触发）判断他是一个小偷，立刻抓拿送到公安局，这种场景下可以理解为每一个施行偷窃（触发事件）的人（被观察者），都会被安保人员（观察者）抓拿送审。但是商场的安保人员无法实时观察每个来到商场的人员，只能在监控室中看各路的监控情况，每个监控一般对应商场的某一条通道，当该监控器正常运行（激活）且监控视频中出现偷窃行为，安保人员就会立刻采取措施抓拿小偷。但是部分商场的通道由于监控器坏了（未激活），导致拿到这条通道内出现偷窃行为，则安保人员也无法知情，自然无法采取抓拿行为。</p>
</blockquote>
<p>上述例子中，监控器存在运行状态，只有当监控器正常运行的时候，安保人员才有可能对监控下的偷窃行为有所感知。如果监控器坏了，则丢失知情权。<strong>所以所谓包装，实际上就是观察者通过关联某个角色，该角色拥有生命周期，不同生命周期都可以表现成 “激活状态” 和 “非激活状态”。</strong>上述例子 “激活状态” 对应监控器运行状态，“非激活状态” 对应监控器损坏状态。在 Android 中 Activity 也可以看成拥有生命周期的角色，resumed 阶段则为 “激活状态”，destoryed 阶段则为 “非激活状态”。<strong>只有当关联角色处于 “激活状态” 时观察者才能感知到被观察者的行为变化。</strong> </p>
<p>如何关联呢？ 看下 <strong>ObserverWrapper</strong> 的实现 （只列出相关核心方法）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; mObserver;</span><br><span class="line">    <span class="keyword">boolean</span> mActive;</span><br><span class="line">    <span class="keyword">int</span> mLastVersion = START_VERSION;</span><br><span class="line"></span><br><span class="line">    ObserverWrapper(Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        mObserver = observer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">        	<span class="keyword">return</span>;</span><br><span class="line">    	&#125;</span><br><span class="line">    	mActive = newActive;</span><br><span class="line">    	<span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接收一个 <em>observer</em> 对象。但是没有看到有关生命周期特征的角色信息，其实是在子类 <strong>LifecycleBoundObserver</strong> 实现. <em>LiveData#observe(LifecycleOwner owner,Observer&lt;? super T&gt; observer)</em> 实现真正关联。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//具有生命周期的对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleBoundObserver</span> <span class="keyword">extends</span> <span class="title">ObserverWrapper</span> <span class="title">implements</span> <span class="title">GenericLifecycleObserver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span> <span class="keyword">final</span> <span class="type">LifecycleOwner</span> mOwner;</span><br><span class="line"></span><br><span class="line">    <span class="type">LifecycleBoundObserver</span>(<span class="meta">@NonNull</span> <span class="type">LifecycleOwner</span> owner, <span class="type">Observer</span>&lt;? <span class="keyword">super</span> <span class="type">T</span>&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">super</span>(observer);</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//只有 started 才算 “激活状态”</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    boolean shouldBeActive() &#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(<span class="type">STARTED</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//实现 GenericLifecycleObserver 接口，生命周期变化也要动态调整 mActive 值</span></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    public void onStateChanged(<span class="type">LifecycleOwner</span> source, <span class="type">Lifecycle</span>.<span class="type">Event</span> event) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mOwner.getLifecycle().getCurrentState() == <span class="type">DESTROYED</span>) &#123;</span><br><span class="line">            removeObserver(mObserver);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        activeStateChanged(shouldBeActive());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">public void observe(<span class="meta">@NonNull</span> <span class="type">LifecycleOwner</span> owner, <span class="meta">@NonNull</span> <span class="type">Observer</span>&lt;? <span class="keyword">super</span> <span class="type">T</span>&gt; observer) &#123;</span><br><span class="line">    <span class="type">LifecycleBoundObserver</span> wrapper = <span class="keyword">new</span> <span class="type">LifecycleBoundObserver</span>(owner, observer);</span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>LiveData#observeForever(Observer&lt;? super T&gt; observer)</em> 也提供了绑定观察者的方法，不需要关联任何生命周期特征的角色，则观察者随时都能获知被观察者的数据变化.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AlwaysActiveObserver</span> <span class="keyword">extends</span> <span class="title">ObserverWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">AlwaysActiveObserver</span>(<span class="type">Observer</span>&lt;? <span class="keyword">super</span> <span class="type">T</span>&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">super</span>(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//默认一直处于激活状态</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    boolean shouldBeActive() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void observeForever(<span class="meta">@NonNull</span> <span class="type">Observer</span>&lt;? <span class="keyword">super</span> <span class="type">T</span>&gt; observer) &#123;</span><br><span class="line">    <span class="type">AlwaysActiveObserver</span> wrapper = <span class="keyword">new</span> <span class="type">AlwaysActiveObserver</span>(observer);</span><br><span class="line">    <span class="comment">//默认设置 mActive 为true</span></span><br><span class="line">    wrapper.activeStateChanged(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述两种场景可以看到 <em>mActive</em> 用于表示是否处于 “激活状态”，同时针对关联生命周期特征的 <strong>LifecycleBoundObserver</strong>，随着自己生命周期的变化，状态也会随着动态更改。</p>
<p>上一章可知，分发数据的逻辑最终落在 <em>LiveData#considerNotify</em> 方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void considerNotify(ObserverWrapper observer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;	<span class="comment">//如果当前状态发生变化，则</span></span><br><span class="line">        observer.activeStateChanged(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    observer.mLastVersion = mVersion;</span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>如果处于非激活状态，返回；</li>
<li>获取最新的状态，如果是从 “激活状态” -&gt; “非激活状态”，则重新更新状态，返回；</li>
<li>如果处于激活状态，但是已经接收过 LiveData 的最新数据，则返回；</li>
<li>接收 LiveData 最新数据更新并更新 mLastVersion。</li>
</ol>
<p>在 <strong>LifecycleBoundObserver</strong> 类中，其实现的 <strong>GenericLifecycleObserver</strong> 是一个用于监听 “拥有生命周期特征的角色” 的生命状态变化。 而 <strong>“拥有生命周期特征的角色”</strong> 到底是个什么东西，见下章节。</p>
<h3 id="谁是拥有-“生命周期特征”-的角色"><a href="#谁是拥有-“生命周期特征”-的角色" class="headerlink" title="谁是拥有 “生命周期特征” 的角色"></a>谁是拥有 “生命周期特征” 的角色</h3><p><strong>LifecycleBoundObserver</strong> 实现的 <strong>GenericLifecycleObserver</strong> 提供的 <em>onStateChanged(LifecycleOwner source, Lifecycle.Event event)</em> 方法中，参数1见名知义，<strong>LifecycleOwner</strong>, <strong>LifecycleOwner</strong> 是一个接口，返回 拥有 “生命周期特征” 的角色。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>LifecycleOwner &#123;</span><br><span class="line">    @NonNull</span><br><span class="line">    Lifecycle getLifecycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Lifecycle</strong> 就是拥有 “生命周期特征” 的角色。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    public <span class="keyword">abstract</span> void addObserver(@NonNull LifecycleObserver observer);</span><br><span class="line">    public <span class="keyword">abstract</span> void removeObserver(@NonNull LifecycleObserver observer);</span><br><span class="line">    public <span class="keyword">abstract</span> State getCurrentState();</span><br><span class="line"></span><br><span class="line">    public <span class="class"><span class="keyword">enum</span> <span class="title">Event</span> &#123;</span></span><br><span class="line">        ON_CREATE,</span><br><span class="line">        ON_START,</span><br><span class="line">        ON_RESUME,</span><br><span class="line">        ON_PAUSE,</span><br><span class="line">        ON_STOP,</span><br><span class="line">        ON_DESTROY,</span><br><span class="line">        ON_ANY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="class"><span class="keyword">enum</span> <span class="title">State</span> &#123;</span></span><br><span class="line"></span><br><span class="line">        DESTROYED,</span><br><span class="line">        INITIALIZED,</span><br><span class="line">        CREATED,</span><br><span class="line">        STARTED,</span><br><span class="line">        RESUMED;</span><br><span class="line"></span><br><span class="line">        public boolean isAtLeast(@NonNull State state) &#123;</span><br><span class="line">            <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Lifecycle</strong> 是一个抽象类，<em>addObserver</em>/<em>removeObserver</em>  用于添加/移除对自身的监听，<em>getCurrentState</em> 用于返回当前自身的生命状态。</li>
<li><strong>Event</strong> 表示 <em>Lifecycle</em> 在某个时刻所发射的事件</li>
<li><strong>State</strong> 表示 <em>Lifecycle</em> 当前所处的状态</li>
</ul>
<p>比如 <em>LifecycleOwner</em> 处于 <strong>STARTED</strong> 状态，<em>LifecycleObserver</em> 则会收到 <strong>ON_CREATE</strong> 和 <strong>ON_START</strong> 事件。<em>LifecycleObserver</em> 实际上是一个空方法的接口，其继承者是 <strong>GenericLifecycleObserver</strong>。</p>
<p><em>LifecycleBoundObserver</em> 作为 <strong>ObserverWrapper</strong> 的实例，完成了观察者对生命周期对象的关联。</p>
<ol>
<li><em>LifecycleBoundObserver.mOwner</em> 间接持有 <em>Lifecycle</em> 对象</li>
<li><strong>LifecycleBoundObserver</strong> 本身实现了 <strong>GenericLifecycleObserver</strong>，就是一个 <em>LifecycleObserver</em> 对象</li>
<li>通过调用 <em>Lifecycle#addObserver</em> / <em>Lifecycle#removeObserver</em> 实现关联</li>
<li>在关联期间，只要 <em>Lifecycle</em> 的状态有变化，就会通过 <em>GenericLifecycleObserver#onStateChanged</em> 回调，进而更新 <em>ObserverWrapper.mActive</em>.</li>
</ol>
<p>至此，谁是拥有 “生命周期特征” 的角色的问题得到解答。同时，从 <strong>Lifecycle</strong> 的角度进一步阐述了 <strong>“Observer 如何关联具有生命周期特征的角色”</strong>。</p>
<p>谁是观察者清楚了。</p>
<p>谁是被观察者也清楚了。</p>
<p>谁是有 “生命周期特征的” 角色也露出水面，观察者如何 “勾搭” 她的也一清二楚。</p>
<p>那么整条逻辑谁来盯着 <strong>有 “生命周期特征的” 角色</strong> 的生命周期变化的？ 从代码的角度就是被 <em>Lifecycle#addObserver</em> 所添加的 <em>LifecycleObserver</em> 对象是何时调用 <strong>GenericLifecycleObserver r#onStateChanged</strong> 方法呢？ 最后一章补上这个逻辑就完整了！</p>
<h3 id="Activity-Fragment-是如何成为-LifecycleOwner？"><a href="#Activity-Fragment-是如何成为-LifecycleOwner？" class="headerlink" title="Activity/Fragment 是如何成为 LifecycleOwner？"></a>Activity/Fragment 是如何成为 LifecycleOwner？</h3><p>标题实际上有些 “剧透”了。在 Android 体系中，<strong>Activity/Fragment</strong> 实际上都是  “生命周期特征” 的角色 的拥有者，就是他们持有 <em>Lifecycle</em> 对象。<em>android.arch.lifecycle</em> 包为 <strong>Lifecycle</strong> 提供了 <strong>LifecycleRegistry</strong> 的实现，旨在为了 <strong>Activity/Fragment</strong> 方便管理多个 <em>LifecycleObserver</em> 的监听。</p>
<p><strong>ComponentActivity</strong> 作为 <strong>Activity</strong> 的子类，实现了 <strong>LifecycleOwner</strong> 接口.同时，也是 <strong>FragmentActivity</strong> 和 <strong>AppCompatActivity</strong> 的父类。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="title">implements</span> <span class="title">LifecycleOwner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">LifecycleRegistry</span> mLifecycleRegistry = <span class="keyword">new</span> <span class="type">LifecycleRegistry</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	public <span class="type">Lifecycle</span> getLifecycle() &#123;</span><br><span class="line">   	 	<span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">FragmentActivity</span> <span class="keyword">extends</span> <span class="title">ComponentActivity</span></span>&#123;&#125;</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AppCompatActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说 <strong>Activity</strong> 实际上是委托 <em>mLifecycleRegistry</em> 完成有关生命周期的事务处理。也就是说，如果你在 <em>activity</em> 调用 <em>LiveData#observe(this,observer)</em></p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> observe(<span class="keyword">@NonNull</span> LifecycleOwner owner, <span class="keyword">@NonNull</span> Observer&lt;T&gt; observer) &#123;</span><br><span class="line">    LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</span><br><span class="line">    <span class="comment">//绑定 LifecycleObserver</span></span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上就是调用 <em>activity.mLifecycleRegistry#addObserver</em> 进行绑定。先认识下 <strong>LifecycleRegistry</strong> 的核心代码逻辑。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleRegistry</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">Lifecycle</span></span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> State mState;</span><br><span class="line">	<span class="keyword">private</span> final WeakReference&lt;LifecycleOwner&gt; mLifecycleOwner;</span><br><span class="line">	<span class="keyword">private</span> ArrayList&lt;State&gt; mParentStates = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> int mAddingObserverCounter = <span class="number">0</span>;   <span class="comment">//是否正在添加 observer</span></span><br><span class="line">   <span class="keyword">private</span> boolean mHandlingEvent = <span class="literal">false</span>;   <span class="comment">//是否正在处理 event 事件</span></span><br><span class="line">   <span class="keyword">private</span> boolean mNewEventOccurred = <span class="literal">false</span>; <span class="comment">//是否有新的事件来临</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//默认使用弱饮用绑定外层 activity，设置初始状态</span></span><br><span class="line">	<span class="keyword">public</span> LifecycleRegistry(@NonNull LifecycleOwner provider) &#123;</span><br><span class="line">        mLifecycleOwner = <span class="keyword">new</span> <span class="type">WeakReference</span>&lt;&gt;(provider);</span><br><span class="line">        mState = INITIALIZED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">   <span class="comment">//内部类，用于每个 LifecycleObserver 关联状态 Lifecycle 的状态</span></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">        State mState;</span><br><span class="line">        GenericLifecycleObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">        ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">        	<span class="comment">//用于保证获取到 LifecycleObserver 的实例</span></span><br><span class="line">            mLifecycleObserver = Lifecycling.getCallback(observer);              </span><br><span class="line">            mState = initialState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		  <span class="comment">//接受 event，然后计算 state 返回，实际上 state 都是通过 event 驱动计算的</span></span><br><span class="line">        void dispatchEvent(LifecycleOwner owner, Event event) &#123;</span><br><span class="line">            State <span class="keyword">new</span><span class="type">State</span> = getStateAfter(event);</span><br><span class="line">            mState = min(mState, <span class="keyword">new</span><span class="type">State</span>);</span><br><span class="line">            mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">            mState = <span class="keyword">new</span><span class="type">State</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//方法一</span></span><br><span class="line">    <span class="keyword">public</span> void addObserver(@NonNull LifecycleObserver observer) &#123;</span><br><span class="line">        <span class="comment">//保存 observer</span></span><br><span class="line">        State initialState = mState == DESTROYED ? DESTROYED : <span class="type">INITIALIZED</span>;</span><br><span class="line">        ObserverWithState statefulObserver = <span class="keyword">new</span> <span class="type">ObserverWithState</span>(observer, initialState);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//去重判断</span></span><br><span class="line">        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line">        <span class="keyword">if</span> (previous != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//lifecycleOwner 是否已经被回收</span></span><br><span class="line">        LifecycleOwner lifecycleOwner = mLifecycleOwner.<span class="keyword">get</span>();</span><br><span class="line">        <span class="keyword">if</span> (lifecycleOwner == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		 <span class="comment">//确保 statefulObserver 的状态是正确的</span></span><br><span class="line">        boolean isReentrance = mAddingObserverCounter != <span class="number">0</span> || mHandlingEvent;</span><br><span class="line">        State targetState = calculateTargetState(observer);</span><br><span class="line">        mAddingObserverCounter++;</span><br><span class="line">        <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">            pushParentState(statefulObserver.mState);</span><br><span class="line">            statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));</span><br><span class="line">            popParentState();</span><br><span class="line">            <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">            targetState = calculateTargetState(observer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">            sync();</span><br><span class="line">        &#125;</span><br><span class="line">        mAddingObserverCounter--;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//方法二，外部设置 event 的入口</span></span><br><span class="line">    <span class="keyword">public</span> void handleLifecycleEvent(@NonNull Lifecycle.Event event) &#123;</span><br><span class="line">        State next = getStateAfter(event);</span><br><span class="line">        moveToState(next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//方法三</span></span><br><span class="line">	<span class="comment">//把 event 转化为 state并</span></span><br><span class="line">    <span class="keyword">private</span> void moveToState(State next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mState == next) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mState = next;</span><br><span class="line">        <span class="keyword">if</span> (mHandlingEvent || mAddingObserverCounter != <span class="number">0</span>) &#123;</span><br><span class="line">            mNewEventOccurred = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// we will figure out what to do on upper level.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mHandlingEvent = <span class="literal">true</span>;</span><br><span class="line">        sync();</span><br><span class="line">        mHandlingEvent = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//方法四 同步 state 给 所有observerWithState 并实现状态回调</span></span><br><span class="line">   <span class="keyword">private</span> void sync() &#123;</span><br><span class="line">        LifecycleOwner lifecycleOwner = mLifecycleOwner.<span class="keyword">get</span>();</span><br><span class="line">        <span class="keyword">if</span> (lifecycleOwner == <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.w(LOG_TAG, <span class="string">"LifecycleOwner is garbage collected, you shouldn't try dispatch "</span></span><br><span class="line">                    + <span class="string">"new events from it."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!isSynced()) &#123;</span><br><span class="line">            mNewEventOccurred = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//mState 越小，则生命周期越靠前（除了DESTROYED），可见 State 枚举类</span></span><br><span class="line">            <span class="comment">//如果第一个 observerWithState 的状态都小于 mState，则所有 observerWithState 存在比他大的都需要更新</span></span><br><span class="line">            <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                backwardPass(lifecycleOwner);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//如果最后一个 observerWithState 的状态都大于 mState，则所有 observerWithState 存在比他小的都需要更新</span></span><br><span class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; <span class="keyword">new</span><span class="type">est</span> = mObserverMap.<span class="keyword">new</span><span class="type">est</span>();</span><br><span class="line">            <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; <span class="keyword">new</span><span class="type">est</span> != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; mState.compareTo(<span class="keyword">new</span><span class="type">est</span>.getValue().mState) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                forwardPass(lifecycleOwner);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mNewEventOccurred = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//方法五</span></span><br><span class="line">    <span class="keyword">private</span> boolean isSynced() &#123;</span><br><span class="line">        <span class="keyword">if</span> (mObserverMap.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        State eldestObserverState = mObserverMap.eldest().getValue().mState;</span><br><span class="line">        State <span class="keyword">new</span><span class="type">estObserverState</span> = mObserverMap.<span class="keyword">new</span><span class="type">est</span>().getValue().mState;</span><br><span class="line">        <span class="keyword">return</span> eldestObserverState == <span class="keyword">new</span><span class="type">estObserverState</span> &amp;&amp; mState == <span class="keyword">new</span><span class="type">estObserverState</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述类信息方法比较多，总结一下：</p>
<ul>
<li>方法一，用于添加监听者 LifecycleObserver ，比较好理解；</li>
<li>方法二，给外部调用，通过接受 Event 来计算当前 State；</li>
<li>方法三，真正设置 State，开始同步工作；</li>
<li>方法四和方法五，主要用于内部的状态同步流程同时把信息同步给外部监听者 LifecycleObserver。</li>
</ul>
<p>对于 <em>handleLifecycleEvent</em>  的调用，实际上我们自然能想到在 <strong>Activity/Fragment</strong> 的各个生命周期阶段回调方法中调用。但是我检索了所有 <strong>Activity/Fragment</strong> 的源码缺没有发现有调用该方法的痕迹。对于 <strong>Activity</strong>，唯一可利用的就是注册<em>Application.ActivityLifecycleCallbacks</em> <strong>Activity</strong> 生命周期回调了。</p>
<blockquote>
<p>如果你也看到 RxPermission 的源码，那么接下来的操作你应该都很熟悉，傀儡化 “Fragment” ！</p>
</blockquote>
<p><em>android.arch.lifecycle</em> 包有一个 <strong>Fragment</strong> 的实现类 <strong>ReportFragment</strong> ，用于帮助为 <strong>Activity/Fragment</strong> 分发 Event 事件的。如果 <em>activity</em> 持有 <em>ReportFragment</em> 对象，那么 <em>ReportFragment</em> 可以分发代表其 <em>activity</em> 生命周期的事件。那么我们只要重写 <em>Fragment</em> 的生命周期回调方法添加事件驱动也就可以解决 <strong>Activity</strong> 生命周期回调的问题。对于 <strong>Activity</strong>内持有的<strong>Fragment</strong>，我们可以通过 <em>FragmentController</em> 实例间接操作 <em>FragmentManager</em> 可获取生命周期变化时机。</p>
<blockquote>
<p>实际上整套体系中非 AndroidX库中还存在 LifecycleRegistryOwner 这个类，旧版本 Activity/Fragment 都实现了这个类用于表示其内部都持有 LifecycleRegistry 对象。但是 AndroidX 已经完全废弃了，源码流程中我都删除了这部分信息，新版本的思路以我下面分析为主。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleDispatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static <span class="type">AtomicBoolean</span> sInitialized = <span class="keyword">new</span> <span class="type">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//静态方法，外部调用注册</span></span><br><span class="line">    static void init(<span class="type">Context</span> context) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sInitialized.getAndSet(<span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ((<span class="type">Application</span>) context.getApplicationContext())</span><br><span class="line">                .registerActivityLifecycleCallbacks(<span class="keyword">new</span> <span class="type">DispatcherActivityCallback</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="class"><span class="keyword">class</span> <span class="title">DispatcherActivityCallback</span> <span class="keyword">extends</span> <span class="title">EmptyActivityLifecycleCallbacks</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        public void onActivityCreated(<span class="type">Activity</span> activity, <span class="type">Bundle</span> savedInstanceState) &#123;</span><br><span class="line">            <span class="type">ReportFragment</span>.injectIfNeededIn(activity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述是在 <em>onActivityCreated</em> 调用 <em>ReportFragment#injectIfNeededIn</em> 注入 <em>activity</em> 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以下类中省略一些源码，只保留核心逻辑</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        android.app.FragmentManager manager = activity.getFragmentManager();</span><br><span class="line">        <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">            manager.executePendingTransactions();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_STOP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        Activity activity = getActivity();</span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">            Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">            <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>ReportFragment</em> 对象最终被添加到 <em>activity</em> 的 <em>fragmentManager</em> 中完成了处理 <strong>Activity</strong> 生命周期事件驱动的使命。但是对于 <strong>FragmentActivity</strong> 内持有的 Fragment，则需要 <strong>FragmentController</strong> 来处理 <em>Fragment</em> 的生命周期而存在的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类一</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentActivity</span> <span class="keyword">extends</span> <span class="title">ComponentActivity</span> <span class="keyword">implements</span> ...</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//HostCallbacks 是 FragmentContainer 对象，实际上 fragment 可以被任何类所持有使用，只是我们常见的 host 就是 Activity 而已。FragmentContainer 中保存 host 的大量信息，比如 FragmentManager</span></span><br><span class="line">	<span class="keyword">final</span> FragmentController mFragments = FragmentController.createController(<span class="keyword">new</span> HostCallbacks());</span><br><span class="line">	</span><br><span class="line">	 <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        mFragments.dispatchCreate();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mCreated) &#123;</span><br><span class="line">            mFragments.dispatchActivityCreated();</span><br><span class="line">        &#125;</span><br><span class="line">        mFragments.dispatchStart();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mFragments.dispatchResume();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mHandler.hasMessages(MSG_RESUME_PENDING)) &#123;</span><br><span class="line">				mFragments.dispatchResume();</span><br><span class="line">        &#125;</span><br><span class="line">        mFragments.dispatchPause();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mFragments.dispatchStop();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mFragments.dispatchDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//类二</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentController</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> FragmentHostCallback&lt;?&gt; mHost;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHost.mFragmentManager.dispatchCreate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchActivityCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHost.mFragmentManager.dispatchActivityCreated();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHost.mFragmentManager.dispatchStart();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHost.mFragmentManager.dispatchResume();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHost.mFragmentManager.dispatchPause();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHost.mFragmentManager.dispatchStop();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchDestroyView</span><span class="params">()</span> </span>&#123;   <span class="comment">//目前并没有找到调用，不影响整体流程</span></span><br><span class="line">        mHost.mFragmentManager.dispatchDestroyView();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHost.mFragmentManager.dispatchDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//类三 略部分代码，保留核心逻辑</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//方法一</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dispatchStateChange(Fragment.CREATED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//方法二</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchActivityCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dispatchStateChange(Fragment.ACTIVITY_CREATED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//方法三</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dispatchStateChange(Fragment.STARTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//方法四</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dispatchStateChange(Fragment.RESUMED);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//方法五</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dispatchStateChange(Fragment.STARTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//方法六</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dispatchStateChange(Fragment.ACTIVITY_CREATED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//方法七</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchDestroyView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dispatchStateChange(Fragment.CREATED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//方法八</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dispatchStateChange(Fragment.INITIALIZING);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//方法九</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchStateChange</span><span class="params">(<span class="keyword">int</span> nextState)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">	        mExecutingActions = <span class="keyword">true</span>;</span><br><span class="line">	        moveToState(nextState, <span class="keyword">false</span>); <span class="comment">//间接调用</span></span><br><span class="line">	    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">	        mExecutingActions = <span class="keyword">false</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    execPendingActions();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//方法十</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(<span class="keyword">int</span> newState, <span class="keyword">boolean</span> always)</span> </span>&#123;</span><br><span class="line">    		<span class="comment">//...</span></span><br><span class="line">    		moveFragmentToExpectedState(f);</span><br><span class="line">    		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//方法十一</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">moveFragmentToExpectedState</span><span class="params">(Fragment f)</span> </span>&#123;</span><br><span class="line">     		<span class="comment">//...</span></span><br><span class="line">     		moveToState(f, nextState, f.getNextTransition(), f.getNextTransitionStyle(), <span class="keyword">false</span>);</span><br><span class="line">     		<span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">	   </span><br><span class="line">	<span class="comment">//方法十二  </span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(Fragment f, <span class="keyword">int</span> newState, <span class="keyword">int</span> transit, <span class="keyword">int</span> transitionStyle,<span class="keyword">boolean</span> keepActive)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">        <span class="keyword">if</span> (f.mState &lt;= newState) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (f.mState) &#123;</span><br><span class="line">                <span class="keyword">case</span> Fragment.INITIALIZING:</span><br><span class="line">                    <span class="keyword">if</span> (newState &gt; Fragment.INITIALIZING) &#123;</span><br><span class="line"></span><br><span class="line">                        dispatchOnFragmentPreAttached(f, mHost.getContext(), <span class="keyword">false</span>);</span><br><span class="line">                        dispatchOnFragmentAttached(f, mHost.getContext(), <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!f.mIsCreated) &#123;</span><br><span class="line">                            dispatchOnFragmentPreCreated(f, f.mSavedFragmentState, <span class="keyword">false</span>);</span><br><span class="line">                            f.performCreate(f.mSavedFragmentState);</span><br><span class="line">                            dispatchOnFragmentCreated(f, f.mSavedFragmentState, <span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                <span class="keyword">case</span> Fragment.CREATED:</span><br><span class="line">                    <span class="keyword">if</span> (newState &gt; Fragment.CREATED) &#123;</span><br><span class="line">                        f.performActivityCreated(f.mSavedFragmentState);</span><br><span class="line">                        dispatchOnFragmentActivityCreated(f, f.mSavedFragmentState, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> Fragment.ACTIVITY_CREATED:</span><br><span class="line">                    <span class="keyword">if</span> (newState &gt; Fragment.ACTIVITY_CREATED) &#123;</span><br><span class="line">                        f.performStart();</span><br><span class="line">                        dispatchOnFragmentStarted(f, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> Fragment.STARTED:</span><br><span class="line">                    <span class="keyword">if</span> (newState &gt; Fragment.STARTED) &#123;</span><br><span class="line">                        f.performResume();</span><br><span class="line">                        dispatchOnFragmentResumed(f, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.mState &gt; newState) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (f.mState) &#123;</span><br><span class="line">                <span class="keyword">case</span> Fragment.RESUMED:</span><br><span class="line">                    <span class="keyword">if</span> (newState &lt; Fragment.RESUMED) &#123;</span><br><span class="line">                        f.performPause();</span><br><span class="line">                        dispatchOnFragmentPaused(f, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> Fragment.STARTED:</span><br><span class="line">                    <span class="keyword">if</span> (newState &lt; Fragment.STARTED) &#123;</span><br><span class="line">                        f.performStop();</span><br><span class="line">                        dispatchOnFragmentStopped(f, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> Fragment.ACTIVITY_CREATED:</span><br><span class="line">                    <span class="keyword">if</span> (newState &lt; Fragment.ACTIVITY_CREATED) &#123;</span><br><span class="line">                        f.performDestroyView();</span><br><span class="line">                        dispatchOnFragmentViewDestroyed(f, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> Fragment.CREATED:</span><br><span class="line">                    <span class="keyword">if</span> (newState &lt; Fragment.CREATED) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (f.getAnimatingAway() != <span class="keyword">null</span> || f.getAnimator() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            newState = Fragment.CREATED;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            f.performDetach();</span><br><span class="line">                            dispatchOnFragmentDetached(f, <span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (f.mState != newState) &#123;</span><br><span class="line">            f.mState = newState;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>上述代码比较长，但是为了完整的逻辑链还是展示出来，最大程度去处了干扰的代码。代码从上到下，逻辑链也是从上到下串起来的。</p>
<ol>
<li>类一 <strong>FragmentActivity</strong> 持有 <em>FragmentController</em> 对象用于管理 <strong>Fragment</strong> 的生命周期，在其自身的生命周期回调中同步调用 <em>FragmentController</em> 的通知方法</li>
<li>类二 <strong>FragmentController</strong> 通过 <em>mHost</em> 操作 <em>FragmentManager</em> 对象，让其代理执行生命周期调用</li>
<li>类三 <strong>FragmentManager</strong> 处理了所有 <strong>Fragment</strong> 的生命周期回调<ul>
<li>方法一至八，对应 <strong>Fragment</strong> 的八个回调</li>
<li>方法九至十二，处理 <strong>Fragment</strong> 的状态</li>
<li>如果 <em>Fragment</em> 存在子 <em>Fragment</em>，则 <em>dispatchOnFragmentXXX</em> 其同步状态</li>
<li><ul>
<li>Fragment #performXXX* 方法用于</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>到这里，还没有涉及 <em>LifecycleRegistry#handleLifecycleEvent</em> 方法调用。实际上 <em>Fragment#performXXX</em> 完成了这最后一步。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">class</span> <span class="selector-tag">Fragment</span> <span class="selector-tag">implements</span> <span class="selector-tag">LifecycleOwner</span>...&#123;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performCreate</span>(Bundle savedInstanceState) &#123;</span><br><span class="line">        <span class="selector-tag">onCreate</span>(savedInstanceState);</span><br><span class="line">        <span class="selector-tag">mLifecycleRegistry</span><span class="selector-class">.handleLifecycleEvent</span>(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performActivityCreated</span>(Bundle savedInstanceState) &#123;</span><br><span class="line">        <span class="selector-tag">onActivityCreated</span>(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performStart</span>() &#123;</span><br><span class="line">        <span class="selector-tag">onStart</span>();</span><br><span class="line">        <span class="selector-tag">mLifecycleRegistry</span><span class="selector-class">.handleLifecycleEvent</span>(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performResume</span>() &#123;</span><br><span class="line">        <span class="selector-tag">onResume</span>();</span><br><span class="line">        <span class="selector-tag">mLifecycleRegistry</span><span class="selector-class">.handleLifecycleEvent</span>(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performPause</span>() &#123;</span><br><span class="line">        <span class="selector-tag">mLifecycleRegistry</span><span class="selector-class">.handleLifecycleEvent</span>(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">        <span class="selector-tag">onPause</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performStop</span>() &#123;</span><br><span class="line">        <span class="selector-tag">mLifecycleRegistry</span><span class="selector-class">.handleLifecycleEvent</span>(Lifecycle.Event.ON_STOP);</span><br><span class="line">        <span class="selector-tag">onStop</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performDestroyView</span>() &#123;</span><br><span class="line">        <span class="selector-tag">onDestroyView</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performDestroy</span>() &#123;</span><br><span class="line">        <span class="selector-tag">mLifecycleRegistry</span><span class="selector-class">.handleLifecycleEvent</span>(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">        <span class="selector-tag">onDestroy</span>();</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-tag">void</span> <span class="selector-tag">performDetach</span>() &#123;</span><br><span class="line">        <span class="selector-tag">onDetach</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说，如果你在 <em>fragment</em> 调用 <em>LiveData#observe(this,observer)</em></p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> observe(<span class="keyword">@NonNull</span> LifecycleOwner owner, <span class="keyword">@NonNull</span> Observer&lt;T&gt; observer) &#123;</span><br><span class="line">    LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</span><br><span class="line">    <span class="comment">//绑定 LifecycleObserver</span></span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上就是调用 <em>fragment.mLifecycleRegistry#addObserver</em> 进行绑定。最后在 <em>fragment</em> 各个生命周期回调用中处理 <em>event</em>，转化成 <em>state</em>，最终反馈到 <em>LifecycleObserver</em> 上！</p>
<h3 id="扩展思考"><a href="#扩展思考" class="headerlink" title="扩展思考"></a>扩展思考</h3><ol>
<li><p>在 <strong>Activity/Fragment 是如何成为 LifecycleOwner？</strong> 篇章出现了 <strong>LifecycleDispatcher</strong> 的这个类，有个 <em>init</em> 方法，我们的应用代码似乎没有调用过 ？ </p>
<ul>
<li>利用 <strong>ContentProvider#onCreate</strong> 是一个非常优秀的方法</li>
</ul>
</li>
<li><p>既然 <strong>Activity/Fragment</strong> 都能做生命周期状态感知，那么 <strong>Application</strong> 应该也是可以吧 ？ 要怎么做呢 ？</p>
<ul>
<li><strong>ProcessLifecycleOwner</strong> 就是做这个事儿！</li>
</ul>
</li>
<li><p>既然 <strong>Fragment</strong> 已经能做到感知生命周期了，那为何还需要 <strong>RepostFragment</strong> ？</p>
<ul>
<li><em>Fragment</em> 哪怕能感知，那什么时候能转成对应 <em>activity</em> 的生命周期呢？ 还是需要重在对应生命周期回调方法。</li>
</ul>
</li>
</ol>
<p>篇幅较长，可能花费较长时间阅读，但是相信会有很大的收获！</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    yummyLau
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yummylau.com/2020/04/06/源码解析——LiveData & Life生命周期完整体系详解/" title="源码解析——LiveData & Lifecycles 完整体系详解">http://yummylau.com/2020/04/06/源码解析——LiveData & Life生命周期完整体系详解/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android进阶/" rel="tag"># Android进阶</a>
          
            <a href="/tags/源码分析/" rel="tag"># 源码分析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/01/基于RxPermission 快速处理权限请求/" rel="next" title="基于 RxPermission 构建权限交互">
                <i class="fa fa-chevron-left"></i> 基于 RxPermission 构建权限交互
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpg" alt="yummyLau">
            
              <p class="site-author-name" itemprop="name">yummyLau</p>
              <p class="site-description motion-element" itemprop="description">努力让自己更优秀。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/YummyLau" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#LiveData-如何接收并分发数据"><span class="nav-number">1.</span> <span class="nav-text">LiveData 如何接收并分发数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Observer-如何关联具有生命周期特征的角色，怎么接收数据"><span class="nav-number">2.</span> <span class="nav-text">Observer 如何关联具有生命周期特征的角色，怎么接收数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#谁是拥有-“生命周期特征”-的角色"><span class="nav-number">3.</span> <span class="nav-text">谁是拥有 “生命周期特征” 的角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity-Fragment-是如何成为-LifecycleOwner？"><span class="nav-number">4.</span> <span class="nav-text">Activity/Fragment 是如何成为 LifecycleOwner？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扩展思考"><span class="nav-number">5.</span> <span class="nav-text">扩展思考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yummyLau</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'pPdkM9YTrgYDV8coDCdALdmi-gzGzoHsz',
        appKey: '5HrONz3gb8XPDrUna01sa0gY',
        placeholder: '留下你的足迹呗 ヾﾉ≧∀≦)o',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
