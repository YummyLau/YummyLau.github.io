<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="热修复,">










<meta name="description" content="基于对热补丁的迫切认识及预研热补丁对当前项目的正向帮助，在主流热补丁技术中选择微信Tinker方案作为学习记录。本次记录基于自身认知及技术水平，如有错误或可改进，望指出。  基础认识 热修复补丁（hotfix），又称为patch，指能够修复软件漏洞的一些代码，是一种快速、低成本修复产品软件版本缺陷的方式。在Android端实现应用在无需重新安装的情况实现更新，帮助应用快速建立动态修复能力。">
<meta name="keywords" content="热修复">
<meta property="og:type" content="article">
<meta property="og:title" content="微信Tinker热修复的预研实践">
<meta property="og:url" content="http://yummylau.com/2017/02/06/Android_2017-02-06_微信Tinker热修复的预研实践/index.html">
<meta property="og:site_name" content="YummyLau">
<meta property="og:description" content="基于对热补丁的迫切认识及预研热补丁对当前项目的正向帮助，在主流热补丁技术中选择微信Tinker方案作为学习记录。本次记录基于自身认知及技术水平，如有错误或可改进，望指出。  基础认识 热修复补丁（hotfix），又称为patch，指能够修复软件漏洞的一些代码，是一种快速、低成本修复产品软件版本缺陷的方式。在Android端实现应用在无需重新安装的情况实现更新，帮助应用快速建立动态修复能力。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-03-10T05:35:03.470Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微信Tinker热修复的预研实践">
<meta name="twitter:description" content="基于对热补丁的迫切认识及预研热补丁对当前项目的正向帮助，在主流热补丁技术中选择微信Tinker方案作为学习记录。本次记录基于自身认知及技术水平，如有错误或可改进，望指出。  基础认识 热修复补丁（hotfix），又称为patch，指能够修复软件漏洞的一些代码，是一种快速、低成本修复产品软件版本缺陷的方式。在Android端实现应用在无需重新安装的情况实现更新，帮助应用快速建立动态修复能力。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yummylau.com/2017/02/06/Android_2017-02-06_微信Tinker热修复的预研实践/">





  <title>微信Tinker热修复的预研实践 | YummyLau</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YummyLau</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Keep moving！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yummylau.com/2017/02/06/Android_2017-02-06_微信Tinker热修复的预研实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yummyLau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YummyLau">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">微信Tinker热修复的预研实践</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-06T09:35:20+08:00">
                2017-02-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/06/Android_2017-02-06_微信Tinker热修复的预研实践/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/02/06/Android_2017-02-06_微信Tinker热修复的预研实践/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <a id="more"></a>
<blockquote>
<p> 基于对热补丁的迫切认识及预研热补丁对当前项目的正向帮助，在主流热补丁技术中选择微信Tinker方案作为学习记录。本次记录基于自身认知及技术水平，如有错误或可改进，望指出。</p>
</blockquote>
<h1 id="基础认识"><a href="#基础认识" class="headerlink" title="基础认识"></a>基础认识</h1><ul>
<li>热修复补丁（hotfix），又称为<strong>patch</strong>，指能够修复软件漏洞的一些代码，是一种快速、低成本修复产品软件版本缺陷的方式。在Android端实现应用在无需重新安装的情况实现更新，帮助应用快速建立动态修复能力。</li>
<li>热修复意义，能节省Android大量应用市场发布的时间。同时用户也无需重新安装，只要上线就能无感知的更新。当然热补丁技术也存在它的局限性，热补丁主要用来进行代码修复和轻量级的升级。</li>
<li>应用场景<ul>
<li>代码修复和轻量级的升级。</li>
<li>远端调试。可以向特定用户特定设备发送补丁，能帮助查找具体的验证问题。利用补丁技术，我们避免了骚扰用户而默默的为用户解决问题。</li>
<li>数据统计。可将热补丁技术与数据统计结合起来。事实上，热补丁技术无论在数据统计还是ABTest都有着非常大的优势。例如若想对同一批用户做两种test, 传统方式无法让这批用户去安装两个版本,使用补丁技术，可以对同一批用户更换补丁达到效果。</li>
</ul>
</li>
</ul>
<h1 id="修复方案的比较"><a href="#修复方案的比较" class="headerlink" title="修复方案的比较"></a>修复方案的比较</h1><table>
<thead>
<tr>
<th style="text-align:center">团队</th>
<th style="text-align:center">Tinker</th>
<th style="text-align:center">QZone</th>
<th style="text-align:center">AndFix</th>
<th style="text-align:center">Robust</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">类替换</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">So替换</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">资源替换</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">全平台支持</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">即时生效</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">性能损耗</td>
<td style="text-align:center">较小</td>
<td style="text-align:center">较大</td>
<td style="text-align:center">较小</td>
<td style="text-align:center">较小</td>
</tr>
<tr>
<td style="text-align:center">补丁包大小</td>
<td style="text-align:center">较小</td>
<td style="text-align:center">较大</td>
<td style="text-align:center">一般</td>
<td style="text-align:center">一般</td>
</tr>
<tr>
<td style="text-align:center">开发透明</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">复杂度</td>
<td style="text-align:center">较低</td>
<td style="text-align:center">较低</td>
<td style="text-align:center">复杂</td>
<td style="text-align:center">复杂</td>
</tr>
<tr>
<td style="text-align:center">gradle支持</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">Rom体积</td>
<td style="text-align:center">较大</td>
<td style="text-align:center">较小</td>
<td style="text-align:center">较小</td>
<td style="text-align:center">较小</td>
</tr>
<tr>
<td style="text-align:center">成功率</td>
<td style="text-align:center">较高</td>
<td style="text-align:center">较高</td>
<td style="text-align:center">一般</td>
<td style="text-align:center">最高</td>
</tr>
</tbody>
</table>
<h1 id="Demo集成开发"><a href="#Demo集成开发" class="headerlink" title="Demo集成开发"></a>Demo集成开发</h1><p>通过集成Tinker SDK来生成补丁包，而官方推荐的补丁包分发则通过<a href="http://www.tinkerpatch.com/" target="_blank" rel="noopener">Tinker Platform</a>来实现。<strong>Tinker Platform</strong>是官方提供的付费分发平台，支持补丁分发监控等功能。如果是小应用则可考虑接入，否则可自行开发CMS补丁管理后台来实现其支持的功能。在预研过程中接入过<strong>Tinker Platform</strong>，实现起来比较简单，可参考<a href="https://github.com/TinkerPatch/tinkerpatch-sample" target="_blank" rel="noopener">官网Demo</a>来实现。</p>
<p><video id="video" controls preload="none" height="640" width="360" poster autoplay muted><br>      <source id="mp4" src="http://ojyx20l6a.bkt.clouddn.com/tinker_test_demo.mp4" type="video/mp4"><br>    </video><br>这里我们才用比较传统的思路来模拟一次分发：客户端主动轮训补丁下载后台或者被动接收推送信令后主动请求下载补丁，然后在客户端中通过Tinker SDK完成补丁的载入与修复，只要理解大致的思路，完全可以开发出满足自身业务的功能。Demo中由于锁屏会默认终端录制，所以选择在修复完之后故意crash一次达到重启，实际项目中可带到锁屏或者应用进入后台之后进行重启即可。</p>
<h2 id="Tinker接入"><a href="#Tinker接入" class="headerlink" title="Tinker接入"></a>Tinker接入</h2><h3 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h3><ul>
<li><p>项目gradle.properties定义tinker版本</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#配置tinker版本为<span class="number">1.7</span><span class="number">.7</span></span><br><span class="line">TINKER_VERSION=<span class="number">1.7</span><span class="number">.7</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>项目build.gradle添加tinker-patch-gradle-plugin的依赖</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加tinker依赖</span></span><br><span class="line">classpath <span class="string">"com.tencent.tinker:tinker-patch-gradle-plugin:<span class="subst">$&#123;TINKER_VERSION&#125;</span>"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>App build.gradle添加tinker的库依赖以及apply tinker的gradle插件</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">//tinker的核心库</span></span><br><span class="line">    compile(<span class="string">"com.tencent.tinker:tinker-android-lib:<span class="subst">$&#123;TINKER_VERSION&#125;</span>"</span>) &#123; changing = <span class="keyword">true</span> &#125;</span><br><span class="line">    <span class="comment">//可选，用于生成application类</span></span><br><span class="line">    provided(<span class="string">"com.tencent.tinker:tinker-android-anno:<span class="subst">$&#123;TINKER_VERSION&#125;</span>"</span>) &#123; changing = <span class="keyword">true</span> &#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>App build.gradle配置参考</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.application'</span></span><br><span class="line"></span><br><span class="line">def javaVersion = JavaVersion.VERSION_1_7</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">24</span></span><br><span class="line">    buildToolsVersion <span class="string">"24.0.3"</span></span><br><span class="line"></span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility javaVersion</span><br><span class="line">        targetCompatibility javaVersion</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//recommend</span></span><br><span class="line">    dexOptions &#123;</span><br><span class="line">        jumboMode = <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//签名信息</span></span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                storeFile file(<span class="string">"./keystore/release.keystore"</span>)</span><br><span class="line">                storePassword <span class="string">"testres"</span></span><br><span class="line">                keyAlias <span class="string">"testres"</span></span><br><span class="line">                keyPassword <span class="string">"testres"</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidUserDataException(ex.toString())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        debug &#123;</span><br><span class="line">            storeFile file(<span class="string">"./keystore/debug.keystore"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">"com.example.yummylau.tinkertest"</span></span><br><span class="line">        minSdkVersion <span class="number">15</span></span><br><span class="line">        targetSdkVersion <span class="number">22</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">"1.0.0"</span></span><br><span class="line">        <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         * </span></span>you<span class="markdown"> can use multiDex and install it in </span>your<span class="markdown"> ApplicationLifeCycle implement</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         */</span></span></span></span><br><span class="line">        multiDexEnabled <span class="keyword">true</span></span><br><span class="line">        <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         * buildConfig can change during patch!</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         * we can use </span></span>the<span class="markdown"> newly value when patch</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         */</span></span></span></span><br><span class="line">        buildConfigField <span class="string">"String"</span>, <span class="string">"MESSAGE"</span>, <span class="string">"\"I am the base apk\""</span></span><br><span class="line">        <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         * client version would update with patch</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         * </span></span>so<span class="markdown"> we can get </span>the<span class="markdown"> newly git version easily!</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         */</span></span></span></span><br><span class="line">        buildConfigField <span class="string">"String"</span>, <span class="string">"TINKER_ID"</span>, <span class="string">"\"<span class="subst">$&#123;getTinkerIdValue()&#125;</span>\""</span></span><br><span class="line">        buildConfigField <span class="string">"String"</span>, <span class="string">"PLATFORM"</span>,  <span class="string">"\"all\""</span></span><br><span class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></span><br><span class="line"></span><br><span class="line">        ndk&#123;</span><br><span class="line">            <span class="comment">//极光推送 添加对应cpu类型的.so库</span></span><br><span class="line">            abiFilters <span class="string">'armeabi'</span>,<span class="string">'armeabi-v7a'</span>,<span class="string">'armeabi-v8a'</span>,<span class="string">'x86'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置极光推送</span></span><br><span class="line">        manifestPlaceholders = [</span><br><span class="line">            JPUSH_PKGNAME : applicationId,</span><br><span class="line">            JPUSH_APPKEY : <span class="string">"your app Jpush_key"</span>,</span><br><span class="line">            JPUSH_CHANNEL : <span class="string">"developer-default"</span>,</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置混淆信息</span></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">        debug &#123;</span><br><span class="line">            debuggable <span class="keyword">true</span></span><br><span class="line">            minifyEnabled <span class="keyword">false</span></span><br><span class="line">            signingConfig signingConfigs.debug</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明libs目录</span></span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        main &#123;</span><br><span class="line">            jniLibs.srcDirs = [<span class="string">'libs'</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span><br><span class="line">    androidTestCompile(<span class="string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>, &#123;</span><br><span class="line">        exclude group: <span class="string">'com.android.support'</span>, module: <span class="string">'support-annotations'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    compile <span class="string">'com.android.support:appcompat-v7:24.2.1'</span></span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line"></span><br><span class="line">    compile <span class="string">"com.android.support:multidex:1.0.1"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//tinker的核心库</span></span><br><span class="line">    compile(<span class="string">"com.tencent.tinker:tinker-android-lib:<span class="subst">$&#123;TINKER_VERSION&#125;</span>"</span>) &#123; changing = <span class="keyword">true</span> &#125;</span><br><span class="line">    <span class="comment">//可选，用于生成application类</span></span><br><span class="line">    provided(<span class="string">"com.tencent.tinker:tinker-android-anno:<span class="subst">$&#123;TINKER_VERSION&#125;</span>"</span>) &#123; changing = <span class="keyword">true</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接入极光推送</span></span><br><span class="line">    compile <span class="string">'cn.jiguang.sdk:jpush:3.0.0'</span></span><br><span class="line">    compile <span class="string">'cn.jiguang.sdk:jcore:1.0.0'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//配置旧包路径</span></span><br><span class="line">def bakPath = file(<span class="string">"<span class="subst">$&#123;buildDir&#125;</span>/bakApk/"</span>)</span><br><span class="line"><span class="comment">//基本配置信息</span></span><br><span class="line">ext &#123;</span><br><span class="line">    <span class="comment">//是否启用tinker热修复</span></span><br><span class="line">    tinkerEnabled = <span class="keyword">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Old Apk路径</span></span><br><span class="line">    tinkerOldApkPath = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/app-debug-0119-19-32-57.apk"</span></span><br><span class="line">    <span class="comment">//proguard mapping路径</span></span><br><span class="line">    tinkerApplyMappingPath = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/app-debug-0119-19-32-57-mapping.txt"</span></span><br><span class="line">    <span class="comment">//resource R.txt路径</span></span><br><span class="line">    tinkerApplyResourcePath = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/app-debug-0119-19-32-57-R.txt"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//only use for build all flavor, if not, just ignore this field</span></span><br><span class="line">    tinkerBuildFlavorDirectory = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/app-debug-0119-19-32-57-R.txt"</span></span><br><span class="line">&#125;</span><br><span class="line">def gitSha() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//把app的versionCode定义为Tinker id</span></span><br><span class="line">        <span class="built_in">String</span> gitRev = android.defaultConfig.versionCode</span><br><span class="line">        <span class="keyword">if</span> (gitRev == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GradleException(<span class="string">"can't get git rev, you should add git to system path or just input test value, such as 'testTinkerId'"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> gitRev</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GradleException(<span class="string">"can't get git rev, you should add git to system path or just input test value, such as 'testTinkerId'"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取OldApk路径</span></span><br><span class="line">def getOldApkPath() &#123;</span><br><span class="line">    <span class="keyword">return</span> hasProperty(<span class="string">"OLD_APK"</span>) ? OLD_APK : ext.tinkerOldApkPath</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取ApplyMapping路径</span></span><br><span class="line">def getApplyMappingPath() &#123;</span><br><span class="line">    <span class="keyword">return</span> hasProperty(<span class="string">"APPLY_MAPPING"</span>) ? APPLY_MAPPING : ext.tinkerApplyMappingPath</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取ApplyResource路径</span></span><br><span class="line">def getApplyResourceMappingPath() &#123;</span><br><span class="line">    <span class="keyword">return</span> hasProperty(<span class="string">"APPLY_RESOURCE"</span>) ? APPLY_RESOURCE : ext.tinkerApplyResourcePath</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取TINKER_ID</span></span><br><span class="line">def getTinkerIdValue() &#123;</span><br><span class="line">    <span class="keyword">return</span> hasProperty(<span class="string">"TINKER_ID"</span>) ? TINKER_ID : gitSha()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//是否启用tinker</span></span><br><span class="line">def buildWithTinker() &#123;</span><br><span class="line">    <span class="keyword">return</span> hasProperty(<span class="string">"TINKER_ENABLE"</span>) ? TINKER_ENABLE : ext.tinkerEnabled</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取多渠道路径</span></span><br><span class="line">def getTinkerBuildFlavorDirectory() &#123;</span><br><span class="line">    <span class="keyword">return</span> ext.tinkerBuildFlavorDirectory</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//tinker的所有操作</span></span><br><span class="line"><span class="keyword">if</span> (buildWithTinker()) &#123;</span><br><span class="line"></span><br><span class="line">    apply plugin: <span class="string">'com.tencent.tinker.patch'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//全局信息相关的配置项</span></span><br><span class="line">    tinkerPatch &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//默认null，	基准apk包的路径，必须输入，否则会报错。</span></span><br><span class="line">        oldApk = getOldApkPath()</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         *  如果出现以下的情况，并且ignoreWarning为false，将中断编译。因为这些情况可能会导致编译出来的patch包带来风险：</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         *  1. minSdkVersion小于14，但是dexMode的值为"raw";</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         *  2. 新编译的安装包出现新增的四大组件(Activity, BroadcastReceiver...)；</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         *  3. 定义在dex.loader用于加载补丁的类不在main dex中;</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         *  4. 定义在dex.loader用于加载补丁的类出现修改；</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         *  5. resources.arsc改变，但没有使用applyResourceMapping编译。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         */</span></span></span></span><br><span class="line">        ignoreWarning = <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         *  在运行过程中，需要验证基准apk包与补丁包的签名是否一致，我们是否需要为你签名。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         */</span></span></span></span><br><span class="line">        useSign = <span class="keyword">true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         *  是否打开tinker的功能。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         */</span></span></span></span><br><span class="line">        tinkerEnable = buildWithTinker()</span><br><span class="line"></span><br><span class="line">        <span class="comment">//编译相关的配置项</span></span><br><span class="line">        buildConfig &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  可选参数；在编译新的apk时候，我们希望通过保持旧apk的proguard混淆方式，从而减少补丁包的大小。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  这个只是推荐的，但设置applyMapping会影响任何的assemble编译。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            applyMapping = getApplyMappingPath()</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 可选参数；在编译新的apk时候，我们希望通过旧apk的R.txt文件保持ResId的分配，这样不仅可以减少</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 补丁包的大小，同时也避免由于ResId改变导致remote view异常。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            applyResourceMapping = getApplyResourceMappingPath()</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	在运行过程中，我们需要验证基准apk包的tinkerId是否等于补丁包的tinkerId。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	这个是决定补丁包能运行在哪些基准包上面，一般来说我们可以使用git版本号、versionName等等。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            tinkerId = getTinkerIdValue()</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	如果我们有多个dex,编译补丁时可能会由于类的移动导致变更增多。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	若打开keepDexApply模式，补丁包将根据基准包的类分布来编译。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            keepDexApply = <span class="keyword">false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//	dex相关的配置项</span></span><br><span class="line">        dex &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	只能是'raw'或者'jar'。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  对于'raw'模式，我们将会保持输入dex的格式。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  对于'jar'模式，我们将会把输入dex重新压缩封装到jar。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  如果你的minSdkVersion小于14，你必须选择‘jar’模式，而且它更省存储空间，但是验证md5时比'raw'模式耗时。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  默认我们并不会去校验md5,一般情况下选择jar模式即可。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            dexMode = <span class="string">"jar"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	需要处理dex路径，支持*、?通配符，必须使用'/'分割。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	路径是相对安装包的，例如assets/...</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            pattern = [<span class="string">"classes*.dex"</span>,</span><br><span class="line">                       <span class="string">"assets/secondary-dex-?.jar"</span>]</span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	这一项非常重要，它定义了哪些类在加载补丁包的时候会用到。这些类是通过Tinker无法修改的类，也是一定要放在main dex的类。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  这里需要定义的类有：</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  1. 你自己定义的Application类；</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  2. Tinker库中用于加载补丁包的部分类，即com.tencent.tinker.loader.*；</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  3. 如果你自定义了TinkerLoader，需要将它以及它引用的所有类也加入loader中；</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  4. 其他一些你不希望被更改的类，例如Sample中的BaseBuildInfo类。这里需要注意的是，这些类的直接引用类也需要加入到loader中。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  或者你需要将这个类变成非preverify。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  5. 使用1.7.6版本之后版本，参数1、2会自动填写。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            loader = [</span><br><span class="line">                    <span class="string">"com.tencent.tinker.loader.*"</span>,</span><br><span class="line">                    <span class="string">"com.tencent.tinker.*"</span>,</span><br><span class="line">                    <span class="string">"com.example.yummylau.tinkertest.report.*"</span>,</span><br><span class="line">                    <span class="string">"com.example.yummylau.tinkertest.crash.*"</span>,</span><br><span class="line">                    <span class="string">"com.example.yummylau.tinkertest.receiver.*"</span>,</span><br><span class="line">                    <span class="string">"com.example.yummylau.tinkertest.service.*"</span>,</span><br><span class="line">                    <span class="string">"com.example.yummylau.tinkertest.TestApplication"</span>,</span><br><span class="line">                    <span class="string">"com.example.yummylau.tinkertest.Constants"</span></span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  lib相关的配置项</span></span><br><span class="line">        lib &#123;</span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	需要处理lib路径，支持*、?通配符，必须使用'/'分割。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	与dex.pattern一致, 路径是相对安装包的，例如assets/...</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            pattern = [<span class="string">"lib/armeabi/*.so"</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//	res相关的配置项</span></span><br><span class="line">        res &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	需要处理res路径，支持*、?通配符，必须使用'/'分割。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	与dex.pattern一致, 路径是相对安装包的，例如assets/...，</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	务必注意的是，只有满足pattern的资源才会放到合成后的资源包。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            pattern = [<span class="string">"res/*"</span>, <span class="string">"assets/*"</span>, <span class="string">"resources.arsc"</span>, <span class="string">"AndroidManifest.xml"</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 支持*、?通配符，必须使用'/'分割。若满足ignoreChange的pattern，在编译时会忽略该文件的新增、删除与修改。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 最极端的情况，ignoreChange与上面的pattern一致，即会完全忽略所有资源的修改。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            ignoreChange = [<span class="string">"assets/sample_meta.txt"</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	对于修改的资源，如果大于largeModSize，我们将使用bsdiff算法。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	这可以降低补丁包的大小，但是会增加合成时的复杂度。默认大小为100kb</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            largeModSize = <span class="number">100</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  用于生成补丁包中的'package_meta.txt'文件</span></span><br><span class="line">        packageConfig &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * NEW_TINKER_ID</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * configField("key", "value"), 默认我们自动从基准安装包与新安装包的Manifest中读取tinkerId,并自动写入configField。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 在这里，你可以定义其他的信息，在运行时可以通过TinkerLoadResult.getPackageConfigByName得到相应的数值。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 但是建议直接通过修改代码来实现，例如BuildConfig。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            configField(<span class="string">"patchMessage"</span>, <span class="string">"tinker is sample to use"</span>)</span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * </span></span>just<span class="markdown"> </span>a<span class="markdown"> sample case, </span>you<span class="markdown"> can use </span>such<span class="markdown"> as sdkVersion, brand, channel...</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * </span></span>you<span class="markdown"> can parse it in </span>the<span class="markdown"> SamplePatchListener.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * Then </span></span>you<span class="markdown"> can use patch conditional!</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            configField(<span class="string">"platform"</span>, <span class="string">"all"</span>)</span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * patch version via packageConfig</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            configField(<span class="string">"patchVersion"</span>, <span class="string">"1"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//or you can add config filed outside, or get meta value from old apk</span></span><br><span class="line">        <span class="comment">//project.tinkerPatch.packageConfig.configField("test1", project.tinkerPatch.packageConfig.getMetaDataFromOldApk("Test"))</span></span><br><span class="line">        <span class="comment">//project.tinkerPatch.packageConfig.configField("test2", "sample")</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//7zip路径配置项，执行前提是useSign为true</span></span><br><span class="line">        sevenZip &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *  例如"com.tencent.mm:SevenZip:1.1.10"，将自动根据机器属性获得对应的7za运行文件，推荐使用。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line">            zipArtifact = <span class="string">"com.tencent.mm:SevenZip:1.1.10"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             * 	系统中的7za路径，例如"/usr/local/bin/7za"。path设置会覆盖zipArtifact，若都不设置，将直接使用7za去尝试。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">             */</span></span></span></span><br><span class="line"><span class="comment">//        path = "/usr/local/bin/7za"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; flavors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    project.android.productFlavors.each &#123;flavor -&gt;</span><br><span class="line">        flavors.add(flavor.name)</span><br><span class="line">    &#125;</span><br><span class="line">    boolean hasFlavors = flavors.size() &gt; <span class="number">0</span></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     * bak apk and mapping</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         * task type, </span></span>you<span class="markdown"> want to bak</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">         */</span></span></span></span><br><span class="line">        def taskName = variant.name</span><br><span class="line">        def date = <span class="keyword">new</span> Date().format(<span class="string">"MMdd-HH-mm-ss"</span>)</span><br><span class="line"></span><br><span class="line">        tasks.all &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"assemble<span class="subst">$&#123;taskName.capitalize()&#125;</span>"</span>.equalsIgnoreCase(it.name)) &#123;</span><br><span class="line"></span><br><span class="line">                it.doLast &#123;</span><br><span class="line">                    copy &#123;</span><br><span class="line">                        def fileNamePrefix = <span class="string">"<span class="subst">$&#123;project.name&#125;</span>-<span class="subst">$&#123;variant.baseName&#125;</span>"</span></span><br><span class="line">                        def newFileNamePrefix = hasFlavors ? <span class="string">"<span class="subst">$&#123;fileNamePrefix&#125;</span>"</span> : <span class="string">"<span class="subst">$&#123;fileNamePrefix&#125;</span>-<span class="subst">$&#123;date&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">                        def destPath = hasFlavors ? file(<span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/<span class="subst">$&#123;project.name&#125;</span>-<span class="subst">$&#123;date&#125;</span>/<span class="subst">$&#123;variant.flavorName&#125;</span>"</span>) : bakPath</span><br><span class="line">                        from variant.outputs.outputFile</span><br><span class="line">                        into destPath</span><br><span class="line">                        rename &#123; <span class="built_in">String</span> fileName -&gt;</span><br><span class="line">                            fileName.replace(<span class="string">"<span class="subst">$&#123;fileNamePrefix&#125;</span>.apk"</span>, <span class="string">"<span class="subst">$&#123;newFileNamePrefix&#125;</span>.apk"</span>)</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        from <span class="string">"<span class="subst">$&#123;buildDir&#125;</span>/outputs/mapping/<span class="subst">$&#123;variant.dirName&#125;</span>/mapping.txt"</span></span><br><span class="line">                        into destPath</span><br><span class="line">                        rename &#123; <span class="built_in">String</span> fileName -&gt;</span><br><span class="line">                            fileName.replace(<span class="string">"mapping.txt"</span>, <span class="string">"<span class="subst">$&#123;newFileNamePrefix&#125;</span>-mapping.txt"</span>)</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        from <span class="string">"<span class="subst">$&#123;buildDir&#125;</span>/intermediates/symbols/<span class="subst">$&#123;variant.dirName&#125;</span>/R.txt"</span></span><br><span class="line">                        into destPath</span><br><span class="line">                        rename &#123; <span class="built_in">String</span> fileName -&gt;</span><br><span class="line">                            fileName.replace(<span class="string">"R.txt"</span>, <span class="string">"<span class="subst">$&#123;newFileNamePrefix&#125;</span>-R.txt"</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    project.afterEvaluate &#123;</span><br><span class="line">        <span class="comment">//sample use for build all flavor for one time</span></span><br><span class="line">        <span class="keyword">if</span> (hasFlavors) &#123;</span><br><span class="line">            task(tinkerPatchAllFlavorRelease) &#123;</span><br><span class="line">                group = <span class="string">'tinker'</span></span><br><span class="line">                def originOldPath = getTinkerBuildFlavorDirectory()</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">String</span> flavor : flavors) &#123;</span><br><span class="line">                    def tinkerTask = tasks.getByName(<span class="string">"tinkerPatch<span class="subst">$&#123;flavor.capitalize()&#125;</span>Release"</span>)</span><br><span class="line">                    dependsOn tinkerTask</span><br><span class="line">                    def preAssembleTask = tasks.getByName(<span class="string">"process<span class="subst">$&#123;flavor.capitalize()&#125;</span>ReleaseManifest"</span>)</span><br><span class="line">                    preAssembleTask.doFirst &#123;</span><br><span class="line">                        <span class="built_in">String</span> flavorName = preAssembleTask.name.substring(<span class="number">7</span>, <span class="number">8</span>).toLowerCase() + preAssembleTask.name.substring(<span class="number">8</span>, preAssembleTask.name.length() - <span class="number">15</span>)</span><br><span class="line">                        project.tinkerPatch.oldApk = <span class="string">"<span class="subst">$&#123;originOldPath&#125;</span>/<span class="subst">$&#123;flavorName&#125;</span>/<span class="subst">$&#123;project.name&#125;</span>-<span class="subst">$&#123;flavorName&#125;</span>-release.apk"</span></span><br><span class="line">                        project.tinkerPatch.buildConfig.applyMapping = <span class="string">"<span class="subst">$&#123;originOldPath&#125;</span>/<span class="subst">$&#123;flavorName&#125;</span>/<span class="subst">$&#123;project.name&#125;</span>-<span class="subst">$&#123;flavorName&#125;</span>-release-mapping.txt"</span></span><br><span class="line">                        project.tinkerPatch.buildConfig.applyResourceMapping = <span class="string">"<span class="subst">$&#123;originOldPath&#125;</span>/<span class="subst">$&#123;flavorName&#125;</span>/<span class="subst">$&#123;project.name&#125;</span>-<span class="subst">$&#123;flavorName&#125;</span>-release-R.txt"</span></span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            task(tinkerPatchAllFlavorDebug) &#123;</span><br><span class="line">                group = <span class="string">'tinker'</span></span><br><span class="line">                def originOldPath = getTinkerBuildFlavorDirectory()</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">String</span> flavor : flavors) &#123;</span><br><span class="line">                    def tinkerTask = tasks.getByName(<span class="string">"tinkerPatch<span class="subst">$&#123;flavor.capitalize()&#125;</span>Debug"</span>)</span><br><span class="line">                    dependsOn tinkerTask</span><br><span class="line">                    def preAssembleTask = tasks.getByName(<span class="string">"process<span class="subst">$&#123;flavor.capitalize()&#125;</span>DebugManifest"</span>)</span><br><span class="line">                    preAssembleTask.doFirst &#123;</span><br><span class="line">                        <span class="built_in">String</span> flavorName = preAssembleTask.name.substring(<span class="number">7</span>, <span class="number">8</span>).toLowerCase() + preAssembleTask.name.substring(<span class="number">8</span>, preAssembleTask.name.length() - <span class="number">13</span>)</span><br><span class="line">                        project.tinkerPatch.oldApk = <span class="string">"<span class="subst">$&#123;originOldPath&#125;</span>/<span class="subst">$&#123;flavorName&#125;</span>/<span class="subst">$&#123;project.name&#125;</span>-<span class="subst">$&#123;flavorName&#125;</span>-debug.apk"</span></span><br><span class="line">                        project.tinkerPatch.buildConfig.applyMapping = <span class="string">"<span class="subst">$&#123;originOldPath&#125;</span>/<span class="subst">$&#123;flavorName&#125;</span>/<span class="subst">$&#123;project.name&#125;</span>-<span class="subst">$&#123;flavorName&#125;</span>-debug-mapping.txt"</span></span><br><span class="line">                        project.tinkerPatch.buildConfig.applyResourceMapping = <span class="string">"<span class="subst">$&#123;originOldPath&#125;</span>/<span class="subst">$&#123;flavorName&#125;</span>/<span class="subst">$&#123;project.name&#125;</span>-<span class="subst">$&#123;flavorName&#125;</span>-debug-R.txt"</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>核心的逻辑是：带修复的apk包存放在<em>bakPath</em>中，然后修复旧包代码后，运行patch脚本生成<strong>Diff 补丁包</strong>，把该补丁包放到分发平台即可。</p>
<h3 id="Application配置"><a href="#Application配置" class="headerlink" title="Application配置"></a>Application配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DefaultLifeCycle</span>(application = <span class="string">"com.example.yummylau.tinkertest.TestApplication"</span>,</span><br><span class="line">        flags = ShareConstants.TINKER_ENABLE_ALL,</span><br><span class="line">        loadVerifyFlag = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">DefaultApplicationLike</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyApplication</span><span class="params">(Application application, <span class="keyword">int</span> tinkerFlags, <span class="keyword">boolean</span> tinkerLoadVerifyFlag, <span class="keyword">long</span> applicationStartElapsedTime, <span class="keyword">long</span> applicationStartMillisTime, Intent tinkerResultIntent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(application, tinkerFlags, tinkerLoadVerifyFlag, applicationStartElapsedTime, applicationStartMillisTime, tinkerResultIntent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        JPushInterface.init(getApplication());</span><br><span class="line">        JPushInterface.setDebugMode(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBaseContextAttached</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onBaseContextAttached(base);</span><br><span class="line">        MultiDex.install(base);</span><br><span class="line"></span><br><span class="line">        TinkerManager.setTinkerApplicationLike(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        TinkerManager.initFastCrashProtect();</span><br><span class="line">        <span class="comment">//should set before tinker is installed</span></span><br><span class="line">        TinkerManager.setUpgradeRetryEnable(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//installTinker after load multiDex</span></span><br><span class="line">        <span class="comment">//or you can put com.tencent.tinker.** to main dex</span></span><br><span class="line">        TinkerManager.installTinker(<span class="keyword">this</span>);</span><br><span class="line">        Tinker tinker = Tinker.with(getApplication());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Application的重写选择官方推荐的“注解方案”，Tinker会自动帮我们生成一个真正的Application，这里需要注意的是<strong>DefaultLifeCycle</strong>中声明的<strong>com.example.yummylau.tinkertest.TestApplication</strong>才是我们真正需要配置的命名，其需要配置主要是在AndroidManifest中<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//appcalition的声明</span></span><br><span class="line">   &lt;application</span><br><span class="line">       android:name=<span class="string">".TestApplication"</span></span><br><span class="line">       android:allowBackup=<span class="string">"true"</span></span><br><span class="line">       android:icon=<span class="string">"@mipmap/icon"</span></span><br><span class="line">       android:label=<span class="string">"@string/app_name"</span></span><br><span class="line">	.....</span><br></pre></td></tr></table></figure></p>
<p>及其依赖配置中 App build.gradle<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dex&#123;</span><br><span class="line">	loader = [</span><br><span class="line">			<span class="string">"com.example.yummylau.tinkertest.TestApplication"</span>,</span><br><span class="line">			......</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="模拟错误场景"><a href="#模拟错误场景" class="headerlink" title="模拟错误场景"></a>模拟错误场景</h3><p>由于Demo演示需要监控Tinker从补丁载入到合并完成的整个过程，开发者可自行实现<a href="https://github.com/Tencent/tinker/wiki/Tinker-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95" target="_blank" rel="noopener">官方监控Api</a> ，这里不做多余展示。<br>在Demo中底部跳转页面过程留了一个空指针<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CrashActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TextView</span> mFixText;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onCreate(<span class="meta">@Nullable</span> <span class="type">Bundle</span> savedInstanceState) &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(<span class="type">R</span>.layout.activity_crash);</span><br><span class="line">        initView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> void initView()&#123;</span><br><span class="line"><span class="comment">//        mFixText = (TextView)findViewById(R.id.fix_info);</span></span><br><span class="line">        <span class="comment">//ignore findViewById() result to bug</span></span><br><span class="line">        mFixText.setText(getString(<span class="type">R</span>.string.to_crash_activity_tip));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后运行项目Gradle 中 Tasks-build-assembleDebug（也可以选择Release版本），会在之前定义的<strong>def bakPath = file(“${buildDir}/bakApk/“)</strong>目录下生成一个以app-debug-date.apk的包，我们这里记录为<strong>旧包</strong>，简记<em>old.apk</em>。<br>接着修复空指针代码<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CrashActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TextView</span> mFixText;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onCreate(<span class="meta">@Nullable</span> <span class="type">Bundle</span> savedInstanceState) &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(<span class="type">R</span>.layout.activity_crash);</span><br><span class="line">        initView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> void initView()&#123;</span><br><span class="line">        mFixText = (<span class="type">TextView</span>)findViewById(<span class="type">R</span>.id.fix_info);</span><br><span class="line">        <span class="comment">//ignore findViewById() result to bug</span></span><br><span class="line">        mFixText.setText(getString(<span class="type">R</span>.string.fix_info));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>并在App build.gradle中配置<strong>旧包</strong>信息<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//基本配置信息</span></span><br><span class="line">ext &#123;</span><br><span class="line">    <span class="comment">//是否启用tinker热修复</span></span><br><span class="line">    tinkerEnabled = <span class="keyword">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Old Apk路径</span></span><br><span class="line">    tinkerOldApkPath = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/old.apk"</span></span><br><span class="line">    <span class="comment">//proguard mapping路径</span></span><br><span class="line">    tinkerApplyMappingPath = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/old-mapping.txt"</span></span><br><span class="line">    <span class="comment">//resource R.txt路径</span></span><br><span class="line">    tinkerApplyResourcePath = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/old7-R.txt"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//only use for build all flavor, if not, just ignore this field</span></span><br><span class="line">    tinkerBuildFlavorDirectory = <span class="string">"<span class="subst">$&#123;bakPath&#125;</span>/old-R.txt"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>debug版本下不需要用到混淆之后的mapping，只需要配置tinkerOldApkPath、tinkerApplyResourcePath及tinkerBuildFlavorDirectory即可。<br>运行项目Gradle 中 Tasks-tinker-tinkerPatchDebug,则会在项目app-build-outputs-tinkerPatch目录中生成<strong>Diff补丁包</strong></p>
<h2 id="上传补丁包"><a href="#上传补丁包" class="headerlink" title="上传补丁包"></a>上传补丁包</h2><p>为了Demo效果，选择<a href="https://www.qiniu.com/" target="_blank" rel="noopener">七牛云</a>暂时托管补丁包，实际生产环境需要考虑补丁包的监控及安全性。把上述生成的<strong>Diff补丁包</strong>上传到私有云空间中，并拿到外链，简记为<em><a href="http://dowmload/patch.zip" target="_blank" rel="noopener">http://dowmload/patch.zip</a></em>。</p>
<h2 id="Jpush推送集成"><a href="#Jpush推送集成" class="headerlink" title="Jpush推送集成"></a>Jpush推送集成</h2><p><a href="https://docs.jiguang.cn/jpush/client/Android/android_sdk/" target="_blank" rel="noopener">Jpush文档</a>对客户端的接入描述已足够清楚，这个不做多余记录。当我们运行上述旧包时，我们的修复策略是客户端主动轮训下载或者服务端主动推送下载信令让客户端实现下载。Demo演示选择后者方案。<br>写一个Jpush远端消息接受处理类<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class JpushReceiver extends BroadcastReceiver&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static final <span class="built_in">String</span> <span class="built_in">TAG</span> = <span class="string">"JpushReceiver"</span>;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="literal">void</span> onReceive(Context context, Intent intent) &#123;</span><br><span class="line">        Bundle bundle = intent.getExtras();</span><br><span class="line">        <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">"onReceive - "</span> + intent.getAction() + <span class="string">", extras: "</span> + bundle.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (JPushInterface.ACTION_REGISTRATION_ID.<span class="keyword">equals</span>(intent.getAction())) &#123;</span><br><span class="line">            <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">"JPush用户注册成功"</span>);</span><br><span class="line">            bundle.putInt(Constants.FLAG, Constants.MESSAGE_FLAG_PUSH_INIT);</span><br><span class="line">            sendBroadcase(context,bundle);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JPushInterface.ACTION_MESSAGE_RECEIVED.<span class="keyword">equals</span>(intent.getAction())) &#123;</span><br><span class="line">            <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">"接受到推送下来的自定义消息"</span>);</span><br><span class="line">            <span class="comment">//服务端下发补丁信令</span></span><br><span class="line">            bundle.putInt(Constants.FLAG, Constants.MESSAGE_FLAG_MESSAGE);</span><br><span class="line">            sendBroadcase(context,bundle);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JPushInterface.ACTION_NOTIFICATION_RECEIVED.<span class="keyword">equals</span>(intent.getAction())) &#123;</span><br><span class="line">            <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">"接受到推送下来的通知"</span>);</span><br><span class="line">            <span class="built_in">String</span> title = bundle.getString(JPushInterface.EXTRA_NOTIFICATION_TITLE);</span><br><span class="line">            <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">" notification-title : "</span> + title);</span><br><span class="line">            <span class="built_in">String</span> message = bundle.getString(JPushInterface.EXTRA_ALERT);</span><br><span class="line">            <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">"notification-message : "</span> + message);</span><br><span class="line">            <span class="built_in">String</span> extras = bundle.getString(JPushInterface.EXTRA_EXTRA);</span><br><span class="line">            <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">"notification-extras : "</span> + extras);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JPushInterface.ACTION_NOTIFICATION_OPENED.<span class="keyword">equals</span>(intent.getAction())) &#123;</span><br><span class="line">            <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">"用户点击打开了通知"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">Log</span>.d(<span class="built_in">TAG</span>, <span class="string">"Unhandled intent - "</span> + intent.getAction());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="literal">void</span> sendBroadcase(Context context, Bundle bundle)&#123;</span><br><span class="line">        Intent intent = <span class="literal">new</span> Intent();</span><br><span class="line">        intent.putExtras(bundle);</span><br><span class="line">        intent.setAction(Constants.BIZ_RECEIVER_ACTION);</span><br><span class="line">        context.sendBroadcast(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在接收到下载信令之后，发个广播通知App需要下载补丁并相应下载。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Constants.MESSAGE_FLAG_MESSAGE:&#123;</span><br><span class="line">	<span class="keyword">if</span>(HandleMessage(bundle.getString(JPushInterface.EXTRA_MESSAGE)))&#123;</span><br><span class="line">		addLog(<span class="string">"start request patch, download...."</span>);</span><br><span class="line">		TaskManager.execAsynTask(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="comment">//下载补丁文件，mPatchUrl实际为外链地址http://dowmload/patch.zip</span></span><br><span class="line">				<span class="keyword">final</span> String result = DowmloadHelper.download(MainActivity.<span class="keyword">this</span>, mPatchUrl,mPatchSize);</span><br><span class="line">				<span class="comment">//下载完成之后合成补丁</span></span><br><span class="line">				TaskManager.execTaskOnUIThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">						<span class="keyword">if</span>(result.equals(DowmloadHelper.DOWNLOAD_SUCCESS))&#123;</span><br><span class="line">							addLog(<span class="string">"开始下载补丁包..."</span>);</span><br><span class="line">								TinkerInstaller.onReceiveUpgradePatch(getApplicationContext(),</span><br><span class="line">										SDCardHelper.getSDCardPrivateFilesDir(MainActivity.<span class="keyword">this</span>, <span class="keyword">null</span>) + <span class="string">"/patch/"</span> + Constants.PATCH_NAME);</span><br><span class="line">							addLog(result);</span><br><span class="line">							addLog(<span class="string">"patch进程服务运行中..."</span>);</span><br><span class="line">							addLog(<span class="string">"请求patch进程合成补丁..."</span>);</span><br><span class="line">						&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">							addLog(result);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下载文件方法,考虑安全性需要存放在data-data目录下的私有空间，补丁合成后会自动删除补丁文件。<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> download(Context context, <span class="keyword">String</span> docUrl, <span class="keyword">int</span> <span class="built_in">size</span>)&#123;</span><br><span class="line">    <span class="built_in">if</span> (SDCardHelper.isSDCardMounted()) &#123;</span><br><span class="line">        <span class="built_in">if</span> (SDCardHelper.getSDCardAvailableSize() &lt; <span class="built_in">size</span> * <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="built_in">return</span> SD_SPACE_LIMIT;</span><br><span class="line">        &#125; <span class="built_in">else</span> &#123;</span><br><span class="line">            <span class="keyword">String</span> dirName = <span class="string">""</span>;</span><br><span class="line">            dirName = SDCardHelper.getSDCardPrivateFilesDir(context, null) + <span class="string">"/patch/"</span>;</span><br><span class="line">            <span class="built_in">File</span> f = <span class="keyword">new</span> <span class="built_in">File</span>(dirName);</span><br><span class="line">            <span class="built_in">if</span> (!f.<span class="built_in">exists</span>()) &#123;      <span class="comment">//判断文件夹是否存在</span></span><br><span class="line">                f.<span class="built_in">mkdir</span>();        <span class="comment">//如果不存在、则创建一个新的文件夹</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">String</span> fileName = Constants.PATCH_NAME;</span><br><span class="line">            fileName = dirName + fileName;</span><br><span class="line">            <span class="built_in">File</span> file = <span class="keyword">new</span> <span class="built_in">File</span>(fileName);</span><br><span class="line">            <span class="built_in">if</span> (file.<span class="built_in">exists</span>()) &#123;    <span class="comment">//如果目标文件已经存在</span></span><br><span class="line">                file.<span class="keyword">delete</span>();    <span class="comment">//则删除旧文件</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//1K的数据缓冲</span></span><br><span class="line">            <span class="keyword">byte</span>[] bs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="comment">//读取到的数据长度</span></span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line">            <span class="built_in">try</span> &#123;</span><br><span class="line">                <span class="comment">//通过文件地址构建url对象</span></span><br><span class="line">                URL url = <span class="keyword">new</span> URL(docUrl);</span><br><span class="line">                <span class="comment">//获取链接</span></span><br><span class="line">                <span class="comment">//URLConnection conn = url.openConnection();</span></span><br><span class="line">                <span class="comment">//创建输入流</span></span><br><span class="line">                InputStream is = url.openStream();</span><br><span class="line">                <span class="comment">//获取文件的长度</span></span><br><span class="line">                <span class="comment">//int contextLength = conn.getContentLength();</span></span><br><span class="line">                <span class="comment">//输出的文件流</span></span><br><span class="line">                OutputStream os = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">                <span class="comment">//开始读取</span></span><br><span class="line">                <span class="built_in">while</span> ((len = is.<span class="built_in">read</span>(bs)) != <span class="number">-1</span>) &#123;</span><br><span class="line">                    os.<span class="built_in">write</span>(bs, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//完毕关闭所有连接</span></span><br><span class="line">                os.<span class="built_in">close</span>();</span><br><span class="line">                is.<span class="built_in">close</span>();</span><br><span class="line">                <span class="built_in">return</span> DOWNLOAD_SUCCESS;</span><br><span class="line">            &#125; <span class="built_in">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">                fileName = null;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="built_in">return</span> URL_CREAT_FAIL;</span><br><span class="line">            &#125; <span class="built_in">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                fileName = null;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="built_in">return</span> LOAD_FILE_FAIL;</span><br><span class="line">            &#125; <span class="built_in">catch</span> (IOException e) &#123;</span><br><span class="line">                fileName = null;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="built_in">return</span> CONNECT_FAIL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="built_in">else</span> &#123;</span><br><span class="line">        <span class="built_in">return</span> SD_NO_LOAD;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Demo集成总结"><a href="#Demo集成总结" class="headerlink" title="Demo集成总结"></a>Demo集成总结</h1><h2 id="一些记录"><a href="#一些记录" class="headerlink" title="一些记录"></a>一些记录</h2><ul>
<li>使用Tinker需要兼容原有Application，建议使用注解方式兼容；</li>
<li>Tinker开放检测补丁载入、合成的监听，建议写一个模块单独处理整个过程并做好容错处理；</li>
<li>Tinker gradle文件中TinkerId建议设置为VersionCoce，同时对于tinkerPatch.dex.loade的配置应该重点关注及配置；</li>
<li>Jpush的混淆配置重点关注； </li>
<li>七牛云对多次覆盖上传文件，每次取文件都会取到缓存文件，受平台缓存限制。</li>
</ul>
<h2 id="一些建议"><a href="#一些建议" class="headerlink" title="一些建议"></a>一些建议</h2><ul>
<li>建议使用Tinker SDK作为热修复技术基础；</li>
<li>设计一套补丁获取机制，可通过客户端主动异步轮训请求和后端主动推送来获取补丁；</li>
<li>建议搭建具有保密传输功能的补丁下载后台；</li>
<li>重点关注app gradle中tinkerPatch.dex.loader的配置，详情见文档说明。</li>
</ul>
<h1 id="问题与思考"><a href="#问题与思考" class="headerlink" title="问题与思考"></a>问题与思考</h1><h2 id="Tinker已知问题"><a href="#Tinker已知问题" class="headerlink" title="Tinker已知问题"></a>Tinker已知问题</h2><ul>
<li>Tinker不支持修改AndroidManifest.xml，Tinker不支持新增四大组件</li>
<li>在Android N上，补丁对应用启动时间有轻微的影响</li>
<li>由于各个厂商的加固实现并不一致，在1.7.6以及之后的版本，tinker不再支持加固的动态更新    </li>
<li>由于Google Play的开发者条款限制，不建议在GP渠道动态更新代码</li>
<li>不支持部分三星android-21机型，加载补丁时会主动抛出”TinkerRuntimeException:checkDexInstall failed”</li>
<li>对于资源替换，不支持修改remoteView。例如transition动画，notification icon以及桌面图标</li>
</ul>
<p>由于Tinker暂时不支持加固与项目App防修改加密加固冲突，故暂时没有引入在实际项目引入Tinker，待观望，如有更好意见或建议请一定要给出…先谢谢啦~</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><blockquote>
<p><a href="https://github.com/Tencent/tinker" target="_blank" rel="noopener">Tinker官方文档</a><br><a href="http://tech.meituan.com/mt-android-auto-split-dex.html" target="_blank" rel="noopener">美团Android DEX自动拆包及动态加载简介</a><br><a href="https://github.com/Tencent/tinker/wiki/Tinker-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95" target="_blank" rel="noopener">安卓App热补丁动态修复技术介绍</a> </p>
</blockquote>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    yummyLau
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yummylau.com/2017/02/06/Android_2017-02-06_微信Tinker热修复的预研实践/" title="微信Tinker热修复的预研实践">http://yummylau.com/2017/02/06/Android_2017-02-06_微信Tinker热修复的预研实践/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/热修复/" rel="tag"># 热修复</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/11/Android_2017-01-11_Android-SystemUI的那点事/" rel="next" title="Android-SystemUI的那点事">
                <i class="fa fa-chevron-left"></i> Android-SystemUI的那点事
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/02/06/读书_2017-02-06_读《打造高质量Android应用》笔记记录/" rel="prev" title="读《打造高质量Android应用》之后记">
                读《打造高质量Android应用》之后记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpg" alt="yummyLau">
            
              <p class="site-author-name" itemprop="name">yummyLau</p>
              <p class="site-description motion-element" itemprop="description">努力让自己更优秀。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/YummyLau" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基础认识"><span class="nav-number">1.</span> <span class="nav-text">基础认识</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#修复方案的比较"><span class="nav-number">2.</span> <span class="nav-text">修复方案的比较</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Demo集成开发"><span class="nav-number">3.</span> <span class="nav-text">Demo集成开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tinker接入"><span class="nav-number">3.1.</span> <span class="nav-text">Tinker接入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖配置"><span class="nav-number">3.1.1.</span> <span class="nav-text">依赖配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Application配置"><span class="nav-number">3.1.2.</span> <span class="nav-text">Application配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模拟错误场景"><span class="nav-number">3.1.3.</span> <span class="nav-text">模拟错误场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#上传补丁包"><span class="nav-number">3.2.</span> <span class="nav-text">上传补丁包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jpush推送集成"><span class="nav-number">3.3.</span> <span class="nav-text">Jpush推送集成</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Demo集成总结"><span class="nav-number">4.</span> <span class="nav-text">Demo集成总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一些记录"><span class="nav-number">4.1.</span> <span class="nav-text">一些记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一些建议"><span class="nav-number">4.2.</span> <span class="nav-text">一些建议</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#问题与思考"><span class="nav-number">5.</span> <span class="nav-text">问题与思考</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tinker已知问题"><span class="nav-number">5.1.</span> <span class="nav-text">Tinker已知问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考文章"><span class="nav-number">6.</span> <span class="nav-text">参考文章</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yummyLau</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'pPdkM9YTrgYDV8coDCdALdmi-gzGzonHsz',
        appKey: '5HrONz3gb8XPDrUna01sa0gY',
        placeholder: '留下你的足迹呗 ヾﾉ≧∀≦)o',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
